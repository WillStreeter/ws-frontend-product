"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var reselect_1 = require("reselect");
var GarmentActionTypes = require("../../../../business-layer/shared-types/actions/garment.action.types");
exports.initialState = {
    ids: [],
    entities: {},
    currentSubSet: [],
    currentCollectionId: ''
};
function reducer(state, action) {
    if (state === void 0) { state = exports.initialState; }
    switch (action.type) {
        case GarmentActionTypes.FETCH_GARMENT_COLLECTION_SUCCESS: {
            console.log('  reducer FETCH_GARMENT_COLLECTION_SUCCESS', action.payload);
            if (action.payload) {
                var garmentCollection = {};
                garmentCollection.id = '' + state.ids.length + Math.floor(Math.random() * (100 - 1)) + 1,
                    garmentCollection.products = action.payload;
                if (state.ids.indexOf(garmentCollection.id) > -1) {
                    return state;
                }
                state = Object.assign({
                    currentSubSet: state.currentSubSet,
                    ids: state.ids.concat([garmentCollection.id]),
                    entities: Object.assign({}, state.entities, (_a = {},
                        _a[garmentCollection.id] = garmentCollection,
                        _a)),
                    currentCollectionId: garmentCollection.id,
                });
            }
            return state;
        }
        case GarmentActionTypes.UPDATE_SORTED_COLLECTION: {
            if (action.payload) {
                var garmentCollection = {};
                var garmentSorted = (action.payload);
                garmentCollection.id = garmentSorted.collectionId;
                garmentCollection.products = (garmentSorted.products).slice();
                console.log('  UPDATE_SORTED_COLLECTION garmentCollection ', garmentCollection);
                console.log('  before state.entities[ garmentCollection.id] ', state.entities[garmentCollection.id]);
                state = Object.assign({
                    currentSubSet: garmentSorted.subSetCollection,
                    ids: state.ids,
                    entities: Object.assign({}, state.entities, (_b = {},
                        _b[garmentCollection.id] = garmentCollection,
                        _b)),
                    currentCollectionId: state.currentCollectionId
                });
            }
            return state;
        }
        case GarmentActionTypes.UPDATE_GARMENT_IN_COLLECTION_SUCCESS: {
            if (action.payload) {
                var garmentUpdate_1 = (action.payload);
                var currentGarmentCollection = state.entities[state.currentCollectionId];
                var garmentProducts = currentGarmentCollection.products.slice();
                garmentProducts = garmentProducts.map(function (product) {
                    if (product.id === garmentUpdate_1.id) {
                        product = Object.assign({}, garmentUpdate_1);
                    }
                    return product;
                });
                state = Object.assign({
                    currentSubSet: state.currentSubSet,
                    ids: state.ids,
                    entities: Object.assign({}, state.entities, (_c = {},
                        _c[currentGarmentCollection.id] = ({
                            id: currentGarmentCollection.id,
                            products: garmentProducts
                        }),
                        _c)),
                    currentCollectionId: state.currentCollectionId
                });
                console.log('  UPDATE_GARMENT_IN_COLLECTION_SUCCESS garmentProducts ', state);
            }
            return state;
        }
        case GarmentActionTypes.ADD_GARMENT_TO_COLLECTION_SUCCESS: {
            if (action.payload) {
                var garmentToAdd = (action.payload);
                var currentGarmentCollection = state.entities[state.currentCollectionId];
                var garmentProducts = currentGarmentCollection.products.concat([garmentToAdd]);
                state = Object.assign({
                    currentSubSet: state.currentSubSet,
                    ids: state.ids,
                    entities: Object.assign({}, state.entities, (_d = {},
                        _d[currentGarmentCollection.id] = ({
                            id: currentGarmentCollection.id,
                            products: garmentProducts
                        }),
                        _d)),
                    currentCollectionId: state.currentCollectionId
                });
            }
            return state;
        }
        default: {
            return state;
        }
    }
    var _a, _b, _c, _d;
}
exports.reducer = reducer;
exports.getEntities = function (state) { return state.entities; };
exports.getIds = function (state) { return state.ids; };
exports.getCurrentCollectionId = function (state) { return state.currentCollectionId; };
exports.getCurrentSubSet = function (state) { return state.currentSubSet; };
exports.getCurrentGarmentCollection = reselect_1.createSelector(exports.getEntities, exports.getCurrentCollectionId, function (entities, currentCollectionId) {
    return entities[currentCollectionId];
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC9kYXRhLWxheWVyL25ncngtZGF0YS9yZWR1Y2Vycy9nYXJtZW50L2dhcm1lbnQucmVkdWNlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHFDQUEwQztBQU0xQyx5R0FBMkc7QUFTOUYsUUFBQSxZQUFZLEdBQVU7SUFDakMsR0FBRyxFQUFFLEVBQUU7SUFDUCxRQUFRLEVBQUUsRUFBRTtJQUNaLGFBQWEsRUFBQyxFQUFFO0lBQ2hCLG1CQUFtQixFQUFDLEVBQUU7Q0FDdkIsQ0FBQztBQUVGLGlCQUF3QixLQUFvQixFQUFFLE1BQThCO0lBQXBELHNCQUFBLEVBQUEsNEJBQW9CO0lBQzFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ2xCLEtBQUssa0JBQWtCLENBQUMsZ0NBQWdDLEVBQUMsQ0FBQztZQUNsRCxPQUFPLENBQUMsR0FBRyxDQUFDLDRDQUE0QyxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQTtZQUM3RSxFQUFFLENBQUEsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztnQkFDaEIsSUFBSyxpQkFBaUIsR0FBa0QsRUFBRSxDQUFDO2dCQUMzRSxpQkFBaUIsQ0FBQyxFQUFFLEdBQUMsRUFBRSxHQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUUsQ0FBQztvQkFDbkYsaUJBQWlCLENBQUMsUUFBUSxHQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUM7Z0JBQzFDLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLGlCQUFpQixDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDakQsTUFBTSxDQUFDLEtBQUssQ0FBQztnQkFDZixDQUFDO2dCQUVGLEtB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ZixDQUFDO0lBQ0gsQ0FBQzs7QUFDUCxDQUFDO0FBcEdELDBCQW9HQztBQVdZLFFBQUEsV0FBVyxHQUFHLFVBQUMsS0FBWSxJQUFLLE9BQUEsS0FBSyxDQUFDLFFBQVEsRUFBZCxDQUFjLENBQUM7QUFFL0MsUUFBQSxNQUFNLEdBQUcsVUFBQyxLQUFZLElBQUssT0FBQSxLQUFLLENBQUMsR0FBRyxFQUFULENBQVMsQ0FBQztBQUVyQyxRQUFBLHNCQUFzQixHQUFHLFVBQUMsS0FBWSxJQUFLLE9BQUEsS0FBSyxDQUFDLG1CQUFtQixFQUF6QixDQUF5QixDQUFDO0FBRXJFLFFBQUEsZ0JBQWdCLEdBQUcsVUFBQyxLQUFZLElBQUssT0FBQSxLQUFLLENBQUMsYUFBYSxFQUFuQixDQUFtQixDQUFDO0FBRXpELFFBQUEsMkJBQTJCLEdBQUkseUJBQWMsQ0FBQyxtQkFBVyxFQUFFLDhCQUFzQixFQUFFLFVBQUMsUUFBUSxFQUFFLG1CQUFtQjtJQUM1SCxNQUFNLENBQUMsUUFBUSxDQUFDLG1CQUFtQixDQUFDLENBQUM7QUFDdkMsQ0FBQyxDQUFDLENBQUMiLCJmaWxlIjoiYXBwL2RhdGEtbGF5ZXIvbmdyeC1kYXRhL3JlZHVjZXJzL2dhcm1lbnQvZ2FybWVudC5yZWR1Y2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY3JlYXRlU2VsZWN0b3IgfSBmcm9tICdyZXNlbGVjdCc7XG5pbXBvcnQgeyBHYXJtZW50TW9kZWwsXG4gICAgICAgICBHYXJtZW50QWRkTW9kZWwsXG4gICAgICAgICBHYXJtZW50U29ydE1vZGVsLFxuICAgICAgICAgR2FybWVudENvbGxlY3Rpb25Nb2RlbH0gZnJvbSAnLi4vLi4vLi4vLi4vYnVzaW5lc3MtbGF5ZXIvbW9kZWxzJztcbmltcG9ydCAqIGFzIGdhcm1lbnRBY3Rpb25zIGZyb20gJy4uLy4uL2FjdGlvbnMvZ2FybWVudC5hY3Rpb25zJztcbmltcG9ydCAqIGFzIEdhcm1lbnRBY3Rpb25UeXBlcyBmcm9tICcuLi8uLi8uLi8uLi9idXNpbmVzcy1sYXllci9zaGFyZWQtdHlwZXMvYWN0aW9ucy9nYXJtZW50LmFjdGlvbi50eXBlcyc7XG5cbmV4cG9ydCAgaW50ZXJmYWNlIFN0YXRlIHtcbiAgaWRzOiBzdHJpbmdbXTtcbiAgZW50aXRpZXM6IHsgW2lkOiBzdHJpbmddOiBHYXJtZW50Q29sbGVjdGlvbk1vZGVsIH07XG4gIGN1cnJlbnRTdWJTZXQ6R2FybWVudE1vZGVsW107XG4gIGN1cnJlbnRDb2xsZWN0aW9uSWQ6c3RyaW5nO1xufVxuXG5leHBvcnQgY29uc3QgaW5pdGlhbFN0YXRlOiBTdGF0ZSA9IHtcbiAgaWRzOiBbXSxcbiAgZW50aXRpZXM6IHt9LFxuICBjdXJyZW50U3ViU2V0OltdLFxuICBjdXJyZW50Q29sbGVjdGlvbklkOicnXG59O1xuXG5leHBvcnQgZnVuY3Rpb24gcmVkdWNlcihzdGF0ZSA9IGluaXRpYWxTdGF0ZSwgYWN0aW9uOiBnYXJtZW50QWN0aW9ucy5BY3Rpb25zKTogU3RhdGUge1xuICBzd2l0Y2ggKGFjdGlvbi50eXBlKSB7XG4gICAgICBjYXNlIEdhcm1lbnRBY3Rpb25UeXBlcy5GRVRDSF9HQVJNRU5UX0NPTExFQ1RJT05fU1VDQ0VTUzp7XG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKCcgIHJlZHVjZXIgRkVUQ0hfR0FSTUVOVF9DT0xMRUNUSU9OX1NVQ0NFU1MnLCBhY3Rpb24ucGF5bG9hZClcbiAgICAgICAgICBpZihhY3Rpb24ucGF5bG9hZCkge1xuICAgICAgICAgICAgICBsZXQgIGdhcm1lbnRDb2xsZWN0aW9uOkdhcm1lbnRDb2xsZWN0aW9uTW9kZWwgPSA8R2FybWVudENvbGxlY3Rpb25Nb2RlbD57fTtcbiAgICAgICAgICAgICAgZ2FybWVudENvbGxlY3Rpb24uaWQ9Jycrc3RhdGUuaWRzLmxlbmd0aCArIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqICgxMDAgLSAxKSkgKzEsXG4gICAgICAgICAgICAgIGdhcm1lbnRDb2xsZWN0aW9uLnByb2R1Y3RzPWFjdGlvbi5wYXlsb2FkO1xuICAgICAgICAgICAgICBpZiAoc3RhdGUuaWRzLmluZGV4T2YoZ2FybWVudENvbGxlY3Rpb24uaWQpID4gLTEpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gc3RhdGU7XG4gICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgIHN0YXRlID0gT2JqZWN0LmFzc2lnbigge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRTdWJTZXQ6c3RhdGUuY3VycmVudFN1YlNldCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZHM6IFsgLi4uc3RhdGUuaWRzLCBnYXJtZW50Q29sbGVjdGlvbi5pZCBdLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVudGl0aWVzOiBPYmplY3QuYXNzaWduKHt9LCBzdGF0ZS5lbnRpdGllcywge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgW2dhcm1lbnRDb2xsZWN0aW9uLmlkXTogZ2FybWVudENvbGxlY3Rpb25cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50Q29sbGVjdGlvbklkOmdhcm1lbnRDb2xsZWN0aW9uLmlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgICAgcmV0dXJuIHN0YXRlO1xuICAgICAgfVxuXG4gICAgICBjYXNlIEdhcm1lbnRBY3Rpb25UeXBlcy5VUERBVEVfU09SVEVEX0NPTExFQ1RJT046e1xuICAgICAgICAgICBpZihhY3Rpb24ucGF5bG9hZCkge1xuICAgICAgICAgICAgICAgIGxldCAgZ2FybWVudENvbGxlY3Rpb246R2FybWVudENvbGxlY3Rpb25Nb2RlbCA9IDxHYXJtZW50Q29sbGVjdGlvbk1vZGVsPnt9O1xuICAgICAgICAgICAgICAgIGNvbnN0IGdhcm1lbnRTb3J0ZWQ6R2FybWVudFNvcnRNb2RlbCA9IDxHYXJtZW50U29ydE1vZGVsPihhY3Rpb24ucGF5bG9hZCk7XG4gICAgICAgICAgICAgICAgZ2FybWVudENvbGxlY3Rpb24uaWQgPSBnYXJtZW50U29ydGVkLmNvbGxlY3Rpb25JZDtcbiAgICAgICAgICAgICAgICBnYXJtZW50Q29sbGVjdGlvbi5wcm9kdWN0cyA9IFsuLi48R2FybWVudE1vZGVsW10+KGdhcm1lbnRTb3J0ZWQucHJvZHVjdHMpXTtcblxuICAgICAgICAgICAgICBjb25zb2xlLmxvZygnICBVUERBVEVfU09SVEVEX0NPTExFQ1RJT04gZ2FybWVudENvbGxlY3Rpb24gJywgZ2FybWVudENvbGxlY3Rpb24gKVxuICAgICAgICAgICAgICBjb25zb2xlLmxvZygnICBiZWZvcmUgc3RhdGUuZW50aXRpZXNbIGdhcm1lbnRDb2xsZWN0aW9uLmlkXSAnLCBzdGF0ZS5lbnRpdGllc1sgZ2FybWVudENvbGxlY3Rpb24uaWRdIClcblxuXG4gICAgICAgICAgICAgc3RhdGUgPSAgT2JqZWN0LmFzc2lnbigge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRTdWJTZXQ6Z2FybWVudFNvcnRlZC5zdWJTZXRDb2xsZWN0aW9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkczogc3RhdGUuaWRzICxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbnRpdGllczogT2JqZWN0LmFzc2lnbih7fSwgc3RhdGUuZW50aXRpZXMsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtnYXJtZW50Q29sbGVjdGlvbi5pZF06IGdhcm1lbnRDb2xsZWN0aW9uXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudENvbGxlY3Rpb25JZDpzdGF0ZS5jdXJyZW50Q29sbGVjdGlvbklkXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgIH1cbiAgICAgICAgICAgcmV0dXJuIHN0YXRlXG5cbiAgICAgIH1cblxuICAgICAgY2FzZSBHYXJtZW50QWN0aW9uVHlwZXMuVVBEQVRFX0dBUk1FTlRfSU5fQ09MTEVDVElPTl9TVUNDRVNTOntcbiAgICAgICAgICAgaWYoYWN0aW9uLnBheWxvYWQpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBnYXJtZW50VXBkYXRlID0gPEdhcm1lbnRNb2RlbD4oYWN0aW9uLnBheWxvYWQpO1xuICAgICAgICAgICAgICAgIGxldCBjdXJyZW50R2FybWVudENvbGxlY3Rpb246R2FybWVudENvbGxlY3Rpb25Nb2RlbCA9IHN0YXRlLmVudGl0aWVzW3N0YXRlLmN1cnJlbnRDb2xsZWN0aW9uSWRdO1xuICAgICAgICAgICAgICAgIGxldCBnYXJtZW50UHJvZHVjdHM6R2FybWVudE1vZGVsW10gPSBbLi4uY3VycmVudEdhcm1lbnRDb2xsZWN0aW9uLnByb2R1Y3RzXTtcbiAgICAgICAgICAgICAgICBnYXJtZW50UHJvZHVjdHM9IGdhcm1lbnRQcm9kdWN0cy5tYXAoKHByb2R1Y3Q6R2FybWVudE1vZGVsKT0+e1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihwcm9kdWN0LmlkID09PSBnYXJtZW50VXBkYXRlLmlkKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2R1Y3QgPSBPYmplY3QuYXNzaWduKHt9LCBnYXJtZW50VXBkYXRlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcHJvZHVjdDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICBzdGF0ZSA9IE9iamVjdC5hc3NpZ24oIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50U3ViU2V0OnN0YXRlLmN1cnJlbnRTdWJTZXQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWRzOiBzdGF0ZS5pZHMgLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVudGl0aWVzOiBPYmplY3QuYXNzaWduKHt9LCBzdGF0ZS5lbnRpdGllcywge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgW2N1cnJlbnRHYXJtZW50Q29sbGVjdGlvbi5pZF06PEdhcm1lbnRDb2xsZWN0aW9uTW9kZWw+KHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOmN1cnJlbnRHYXJtZW50Q29sbGVjdGlvbi5pZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2R1Y3RzOmdhcm1lbnRQcm9kdWN0c30pXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudENvbGxlY3Rpb25JZDpzdGF0ZS5jdXJyZW50Q29sbGVjdGlvbklkXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnICBVUERBVEVfR0FSTUVOVF9JTl9DT0xMRUNUSU9OX1NVQ0NFU1MgZ2FybWVudFByb2R1Y3RzICcsIHN0YXRlKVxuICAgICAgICAgICB9XG4gICAgICAgICAgIHJldHVybiBzdGF0ZVxuICAgICAgfVxuXG4gICAgICBjYXNlIEdhcm1lbnRBY3Rpb25UeXBlcy5BRERfR0FSTUVOVF9UT19DT0xMRUNUSU9OX1NVQ0NFU1M6e1xuICAgICAgICAgICBpZihhY3Rpb24ucGF5bG9hZCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGdhcm1lbnRUb0FkZCA9IDxHYXJtZW50TW9kZWw+KGFjdGlvbi5wYXlsb2FkKTtcbiAgICAgICAgICAgICAgICBsZXQgY3VycmVudEdhcm1lbnRDb2xsZWN0aW9uOkdhcm1lbnRDb2xsZWN0aW9uTW9kZWwgPSBzdGF0ZS5lbnRpdGllc1tzdGF0ZS5jdXJyZW50Q29sbGVjdGlvbklkXTtcbiAgICAgICAgICAgICAgICBsZXQgZ2FybWVudFByb2R1Y3RzOkdhcm1lbnRNb2RlbFtdID0gWy4uLmN1cnJlbnRHYXJtZW50Q29sbGVjdGlvbi5wcm9kdWN0cywgZ2FybWVudFRvQWRkXTtcbiAgICAgICAgICAgICAgICAgc3RhdGUgPSBPYmplY3QuYXNzaWduKCB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudFN1YlNldDpzdGF0ZS5jdXJyZW50U3ViU2V0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkczogc3RhdGUuaWRzICxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbnRpdGllczogT2JqZWN0LmFzc2lnbih7fSwgc3RhdGUuZW50aXRpZXMsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtjdXJyZW50R2FybWVudENvbGxlY3Rpb24uaWRdOjxHYXJtZW50Q29sbGVjdGlvbk1vZGVsPih7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDpjdXJyZW50R2FybWVudENvbGxlY3Rpb24uaWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9kdWN0czpnYXJtZW50UHJvZHVjdHN9KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRDb2xsZWN0aW9uSWQ6c3RhdGUuY3VycmVudENvbGxlY3Rpb25JZFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgfVxuICAgICAgICAgICByZXR1cm4gc3RhdGU7XG5cbiAgICAgIH1cblxuICAgICAgZGVmYXVsdDoge1xuICAgICAgICAgIHJldHVybiBzdGF0ZTtcbiAgICAgICAgfVxuICAgICAgfVxufVxuXG4vKipcbiAqIEJlY2F1c2UgdGhlIGRhdGEgc3RydWN0dXJlIGlzIGRlZmluZWQgd2l0aGluIHRoZSByZWR1Y2VyIGl0IGlzIG9wdGltYWwgdG9cbiAqIGxvY2F0ZSBvdXIgc2VsZWN0b3IgZnVuY3Rpb25zIGF0IHRoaXMgbGV2ZWwuIElmIHN0b3JlIGlzIHRvIGJlIHRob3VnaHQgb2ZcbiAqIGFzIGEgZGF0YWJhc2UsIGFuZCByZWR1Y2VycyB0aGUgdGFibGVzLCBzZWxlY3RvcnMgY2FuIGJlIGNvbnNpZGVyZWQgdGhlXG4gKiBxdWVyaWVzIGludG8gc2FpZCBkYXRhYmFzZS4gUmVtZW1iZXIgdG8ga2VlcCB5b3VyIHNlbGVjdG9ycyBzbWFsbCBhbmRcbiAqIGZvY3VzZWQgc28gdGhleSBjYW4gYmUgY29tYmluZWQgYW5kIGNvbXBvc2VkIHRvIGZpdCBlYWNoIHBhcnRpY3VsYXJcbiAqIHVzZS1jYXNlLlxuICovXG5cbmV4cG9ydCBjb25zdCBnZXRFbnRpdGllcyA9IChzdGF0ZTogU3RhdGUpID0+IHN0YXRlLmVudGl0aWVzO1xuXG5leHBvcnQgY29uc3QgZ2V0SWRzID0gKHN0YXRlOiBTdGF0ZSkgPT4gc3RhdGUuaWRzO1xuXG5leHBvcnQgY29uc3QgZ2V0Q3VycmVudENvbGxlY3Rpb25JZCA9IChzdGF0ZTogU3RhdGUpID0+IHN0YXRlLmN1cnJlbnRDb2xsZWN0aW9uSWQ7XG5cbmV4cG9ydCBjb25zdCBnZXRDdXJyZW50U3ViU2V0ID0gKHN0YXRlOiBTdGF0ZSkgPT4gc3RhdGUuY3VycmVudFN1YlNldDtcblxuZXhwb3J0IGNvbnN0IGdldEN1cnJlbnRHYXJtZW50Q29sbGVjdGlvbiAgPSBjcmVhdGVTZWxlY3RvcihnZXRFbnRpdGllcywgZ2V0Q3VycmVudENvbGxlY3Rpb25JZCwgKGVudGl0aWVzLCBjdXJyZW50Q29sbGVjdGlvbklkKSA9PiB7XG4gIHJldHVybiBlbnRpdGllc1tjdXJyZW50Q29sbGVjdGlvbklkXTtcbn0pO1xuXG5cbiJdfQ==
