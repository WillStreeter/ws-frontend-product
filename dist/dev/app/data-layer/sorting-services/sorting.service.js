"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var store_1 = require("@ngrx/store");
var Observable_1 = require("rxjs/Observable");
require("rxjs/add/observable/of");
var fromRoot = require("../ngrx-data/reducers/index");
var sort_config_types_1 = require("../../business-layer/shared-types/sorters/sort.config.types");
var SortingServices = (function () {
    function SortingServices(store) {
        this.store = store;
    }
    SortingServices.prototype.getCollectionSubset = function () {
        this.setMostCurrentStoreValues();
        var collectionSubset = this.createGarmentSubSet();
        return Observable_1.Observable.of({ collectionId: this.collectionId,
            sortType: this.sortStateVal.sortType,
            subSetCollection: collectionSubset,
            products: this.garmentProducts });
    };
    SortingServices.prototype.sortGarmentCollection = function () {
        this.setMostCurrentStoreValues();
        this.sortCollection();
        var collectionSubset = this.createGarmentSubSet();
        return Observable_1.Observable.of({ collectionId: this.collectionId,
            sortType: this.sortStateVal.sortType,
            subSetCollection: collectionSubset,
            products: this.garmentProducts });
    };
    SortingServices.prototype.searchGarmentCollection = function (searchTerm) {
        var _this = this;
        this.setMostCurrentStoreValues();
        var termsInset = this.findTermsInCollectionNames(searchTerm);
        var clonedGM = this.garmentProducts.slice();
        termsInset.forEach(function (item, index) {
            _this.moveElementsInList(item.index, index, clonedGM);
        });
        return Observable_1.Observable.of({ collectionId: this.collectionId,
            sortType: this.sortStateVal.sortType,
            subSetCollection: clonedGM,
            products: this.garmentProducts });
    };
    SortingServices.prototype.findTermsInCollectionNames = function (searchTerm) {
        var stringObjects = { rank: -1, index: -1 };
        var termList = [];
        this.garmentProducts.forEach(function (item, index) {
            var rank = item.name.search(searchTerm);
            if (rank > -1) {
                termList.push({ rank: (rank + 1), index: index });
            }
        });
        if (termList.length > 0) {
            return this.doNumericalSort(termList, 'rank');
        }
        else {
            return termList;
        }
    };
    SortingServices.prototype.sortCollection = function () {
        if (sort_config_types_1.SORT_BASES[this.sortStateVal.sortBase].dataType === "string") {
            this.garmentProducts = this.doAlphaSort(this.garmentProducts, sort_config_types_1.SORT_BASES[this.sortStateVal.sortBase].attr);
            if (this.sortStateVal.sortDirection == "Descending") {
                this.garmentProducts = this.garmentProducts.reverse();
            }
        }
        else if (sort_config_types_1.SORT_BASES[this.sortStateVal.sortBase].dataType === "number") {
            this.garmentProducts = this.doNumericalSort(this.garmentProducts, sort_config_types_1.SORT_BASES[this.sortStateVal.sortBase].attr);
            if (this.sortStateVal.sortDirection == "Descending") {
                this.garmentProducts = this.garmentProducts.reverse();
            }
        }
        else {
            this.garmentProducts = this.doTypeSort(this.garmentProducts, sort_config_types_1.SORT_BASES[this.sortStateVal.sortBase].attr);
        }
        return this.garmentProducts;
    };
    SortingServices.prototype.setMostCurrentStoreValues = function () {
        var _this = this;
        this.garmentStore$ = this.store.select(fromRoot.getGarmentsState).subscribe(function (val) {
            _this.collectionId = val.currentCollectionId;
            _this.currentGarmentCollection = val.entities[_this.collectionId];
            _this.garmentProducts = _this.currentGarmentCollection.products;
        });
        this.garmentStore$.unsubscribe();
        this.sortState$ = this.store.select(fromRoot.getPortalState).subscribe(function (val) {
            _this.sortStateVal = val;
        });
        this.sortState$.unsubscribe();
    };
    SortingServices.prototype.doAlphaSort = function (list, base) {
        var value = list.slice().sort(function (firstTerm, secondTerm) {
            var a = firstTerm[base].toLowerCase();
            var b = secondTerm[base].toLowerCase();
            if (a > b) {
                return 1;
            }
            if (a < b) {
                return -1;
            }
            return 0;
        });
        return value;
    };
    SortingServices.prototype.doNumericalSort = function (list, base) {
        return list.slice().sort(function (firstTerm, secondTerm) {
            return (firstTerm[base] - (secondTerm)[base]);
        });
    };
    SortingServices.prototype.doTypeSort = function (list, type) {
        var Physical = [];
        var Digital = [];
        var Service = [];
        list.forEach(function (item) {
            switch (item.type) {
                case "Physical":
                    Physical.push(item);
                    break;
                case "Digital":
                    Digital.push(item);
                    break;
                case "Service":
                    Service.push(item);
                    break;
            }
        });
        var typeSorted;
        switch (type) {
            case "Physical":
                typeSorted = Physical.concat(Digital, Service);
                break;
            case "Digital":
                typeSorted = Digital.concat(Physical, Service);
                break;
            case "Service":
                typeSorted = Service.concat(Physical, Digital);
                break;
        }
        return typeSorted;
    };
    SortingServices.prototype.moveElementsInList = function (crntIndex, newIndex, list) {
        list.splice(newIndex, 0, list.splice(crntIndex, 1)[0]);
    };
    SortingServices.prototype.createGarmentSubSet = function () {
        var pages = Math.ceil(this.garmentProducts.length / this.sortStateVal.viewablePerPage);
        var start = (this.sortStateVal.currentPage - 1) * this.sortStateVal.viewablePerPage;
        var end = (this.sortStateVal.currentPage === pages) ?
            this.garmentProducts.length :
            this.sortStateVal.viewablePerPage * this.sortStateVal.currentPage;
        return this.garmentProducts.slice(start, end);
    };
    return SortingServices;
}());
SortingServices = __decorate([
    core_1.Injectable(),
    __metadata("design:paramtypes", [store_1.Store])
], SortingServices);
exports.SortingServices = SortingServices;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC9kYXRhLWxheWVyL3NvcnRpbmctc2VydmljZXMvc29ydGluZy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBR0Esc0NBQXlDO0FBQ3pDLHFDQUFvQztBQUVwQyw4Q0FBNkM7QUFDN0Msa0NBQWdDO0FBQ2hDLHNEQUF3RDtBQUV4RCxpR0FBMEY7QUFJMUYsSUFBYSxlQUFlO0lBYXhCLHlCQUFxQixLQUE0QjtRQUE1QixVQUFLLEdBQUwsS0FBSyxDQUF1QjtJQUFFLENBQUM7SUFLcEQsNkNBQW1CLEdBQW5CO1FBQ0ksSUFBSSxDQUFDLHlCQUF5QixFQUFFLENBQUM7UUFDakMsSUFBSSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztRQUNsRCxNQUFNLENBQUMsdUJBQVUsQ0FBQyxFQUFFLENBQW1CLEVBQUcsWUFBWSxFQUFDLElBQUksQ0FBQyxZQUFZO1lBQ3BFLFFBQVEsRUFBQyxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVE7WUFDbkMsZ0JBQWdCLEVBQUMsZ0JBQWdCO1lBQ2pDLFFBQVEsRUFBQyxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUMsQ0FBQTtJQUN4QyxDQUFDO0lBR0QsK0NBQXFCLEdBQXJCO1FBQ0ksSUFBSSxDQUFDLHlCQUF5QixFQUFFLENBQUM7UUFDakMsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQ3RCLElBQUksZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7UUFDbEQsTUFBTSxDQUFDLHVCQUFVLENBQUMsRUFBRSxDQUFtQixFQUFHLFlBQVksRUFBQyxJQUFJLENBQUMsWUFBWTtZQUM5QixRQUFRLEVBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRO1lBQ25DLGdCQUFnQixFQUFDLGdCQUFnQjtZQUNqQyxRQUFRLEVBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDLENBQUM7SUFDOUUsQ0FBQztJQUVELGlEQUF1QixHQUF2QixVQUF3QixV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ZSxDQUFDLENBQUM7UUFDekYsSUFBTSxLQUFLLEdBQUcsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsR0FBRyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLGVBQWUsQ0FBQztRQUN0RixJQUFNLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxLQUFLLEtBQUssQ0FBQztZQUNqRCxJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU07WUFDM0IsSUFBSSxDQUFDLFlBQVksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUM7UUFDdEUsTUFBTSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztJQUNsRCxDQUFDO0lBR0wsc0JBQUM7QUFBRCxDQW5MQSxBQW1MQyxJQUFBO0FBbkxZLGVBQWU7SUFEM0IsaUJBQVUsRUFBRTtxQ0FjbUIsYUFBSztHQWJ4QixlQUFlLENBbUwzQjtBQW5MWSwwQ0FBZSIsImZpbGUiOiJhcHAvZGF0YS1sYXllci9zb3J0aW5nLXNlcnZpY2VzL3NvcnRpbmcuc2VydmljZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ3JlYXRlZCBieSB3aWxsc3RyZWV0ZXIgb24gOS84LzE3LlxuICovXG5pbXBvcnQge0luamVjdGFibGV9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5pbXBvcnQgeyBTdG9yZSB9IGZyb20gXCJAbmdyeC9zdG9yZVwiO1xuaW1wb3J0IHsgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcy9TdWJzY3JpcHRpb24nO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMvT2JzZXJ2YWJsZSc7XG5pbXBvcnQgJ3J4anMvYWRkL29ic2VydmFibGUvb2YnO1xuaW1wb3J0ICogYXMgZnJvbVJvb3QgZnJvbSAnLi4vbmdyeC1kYXRhL3JlZHVjZXJzL2luZGV4JztcbmltcG9ydCB7IEdhcm1lbnRNb2RlbCwgR2FybWVudENvbGxlY3Rpb25Nb2RlbCwgR2FybWVudFNvcnRNb2RlbCB9IGZyb20gXCIuLi8uLi9idXNpbmVzcy1sYXllci9tb2RlbHMvaW5kZXhcIjtcbmltcG9ydCB7IFNPUlRfQkFTRVMgIH0gZnJvbSBcIi4uLy4uL2J1c2luZXNzLWxheWVyL3NoYXJlZC10eXBlcy9zb3J0ZXJzL3NvcnQuY29uZmlnLnR5cGVzXCI7XG5cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFNvcnRpbmdTZXJ2aWNlcyB7XG5cbiAgICBwcml2YXRlIHNvcnRTdGF0ZSQ6U3Vic2NyaXB0aW9uO1xuICAgIHByaXZhdGUgZ2FybWVudFN0b3JlJDpTdWJzY3JpcHRpb247XG4gICAgcHJpdmF0ZSBjdXJyZW50R2FybWVudENvbGxlY3Rpb246R2FybWVudENvbGxlY3Rpb25Nb2RlbDtcbiAgICBwcml2YXRlIGdhcm1lbnRQcm9kdWN0czpHYXJtZW50TW9kZWxbXTtcbiAgICBwcml2YXRlIHNvcnRTdGF0ZVZhbDphbnk7XG5cbiAgICBwcml2YXRlIGN1cnJlbnRQYWdlOmFueTtcbiAgICBwcml2YXRlIHZpZXdhYmxlUGVyUGFnZTphbnk7XG4gICAgcHJpdmF0ZSBjb2xsZWN0aW9uSWQ6c3RyaW5nO1xuXG5cbiAgICBjb25zdHJ1Y3RvciggcHJpdmF0ZSBzdG9yZTogU3RvcmU8ZnJvbVJvb3QuU3RhdGU+KXt9XG5cblxuXG5cbiAgICBnZXRDb2xsZWN0aW9uU3Vic2V0KCl7XG4gICAgICAgIHRoaXMuc2V0TW9zdEN1cnJlbnRTdG9yZVZhbHVlcygpO1xuICAgICAgICBsZXQgY29sbGVjdGlvblN1YnNldCA9IHRoaXMuY3JlYXRlR2FybWVudFN1YlNldCgpO1xuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5vZig8R2FybWVudFNvcnRNb2RlbD57ICBjb2xsZWN0aW9uSWQ6dGhpcy5jb2xsZWN0aW9uSWQsXG4gICAgICAgICAgICBzb3J0VHlwZTp0aGlzLnNvcnRTdGF0ZVZhbC5zb3J0VHlwZSxcbiAgICAgICAgICAgIHN1YlNldENvbGxlY3Rpb246Y29sbGVjdGlvblN1YnNldCxcbiAgICAgICAgICAgIHByb2R1Y3RzOnRoaXMuZ2FybWVudFByb2R1Y3RzIH0pXG4gICAgfVxuXG5cbiAgICBzb3J0R2FybWVudENvbGxlY3Rpb24oKXtcbiAgICAgICAgdGhpcy5zZXRNb3N0Q3VycmVudFN0b3JlVmFsdWVzKCk7XG4gICAgICAgIHRoaXMuc29ydENvbGxlY3Rpb24oKTtcbiAgICAgICAgbGV0IGNvbGxlY3Rpb25TdWJzZXQgPSB0aGlzLmNyZWF0ZUdhcm1lbnRTdWJTZXQoKTtcbiAgICAgICAgcmV0dXJuIE9ic2VydmFibGUub2YoPEdhcm1lbnRTb3J0TW9kZWw+eyAgY29sbGVjdGlvbklkOnRoaXMuY29sbGVjdGlvbklkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzb3J0VHlwZTp0aGlzLnNvcnRTdGF0ZVZhbC5zb3J0VHlwZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ViU2V0Q29sbGVjdGlvbjpjb2xsZWN0aW9uU3Vic2V0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9kdWN0czp0aGlzLmdhcm1lbnRQcm9kdWN0cyB9KTtcbiAgICAgfVxuXG4gICAgIHNlYXJjaEdhcm1lbnRDb2xsZWN0aW9uKHNlYXJjaFRlcm06c3RyaW5nKXtcbiAgICAgICAgIHRoaXMuc2V0TW9zdEN1cnJlbnRTdG9yZVZhbHVlcygpO1xuICAgICAgICAgbGV0IHRlcm1zSW5zZXQ6YW55W10gPSB0aGlzLmZpbmRUZXJtc0luQ29sbGVjdGlvbk5hbWVzKHNlYXJjaFRlcm0pO1xuICAgICAgICAgbGV0IGNsb25lZEdNOkdhcm1lbnRNb2RlbFtdID0gWy4uLnRoaXMuZ2FybWVudFByb2R1Y3RzXTtcbiAgICAgICAgIHRlcm1zSW5zZXQuZm9yRWFjaCggKGl0ZW0sIGluZGV4KT0+e1xuICAgICAgICAgICAgIHRoaXMubW92ZUVsZW1lbnRzSW5MaXN0KGl0ZW0uaW5kZXgsIGluZGV4LCBjbG9uZWRHTSlcbiAgICAgICAgIH0pO1xuICAgICAgICAgcmV0dXJuIE9ic2VydmFibGUub2YoPEdhcm1lbnRTb3J0TW9kZWw+eyAgY29sbGVjdGlvbklkOnRoaXMuY29sbGVjdGlvbklkLFxuICAgICAgICAgICAgIHNvcnRUeXBlOnRoaXMuc29ydFN0YXRlVmFsLnNvcnRUeXBlLFxuICAgICAgICAgICAgIHN1YlNldENvbGxlY3Rpb246Y2xvbmVkR00sXG4gICAgICAgICAgICAgcHJvZHVjdHM6dGhpcy5nYXJtZW50UHJvZHVjdHMgfSk7XG5cblxuICAgICB9XG5cbiAgICAgcHJpdmF0ZSBmaW5kVGVybXNJbkNvbGxlY3Rpb25OYW1lcyhzZWFyY2hUZXJtOnN0cmluZyl7XG4gICAgICAgICAgIGxldCBzdHJpbmdPYmplY3RzOmFueSA9IHsgcmFuazotMSwgaW5kZXg6LTEgIH07XG4gICAgICAgICAgIGxldCB0ZXJtTGlzdCA9IFtdO1xuICAgICAgICAgICB0aGlzLmdhcm1lbnRQcm9kdWN0cy5mb3JFYWNoKChpdGVtLCBpbmRleCk9PiB7XG4gICAgICAgICAgICAgICBjb25zdCByYW5rOiBudW1iZXIgPSBpdGVtLm5hbWUuc2VhcmNoKHNlYXJjaFRlcm0pO1xuICAgICAgICAgICAgICAgaWYgKHJhbmsgPiAtMSkge1xuICAgICAgICAgICAgICAgICAgIHRlcm1MaXN0LnB1c2goe3Jhbms6IChyYW5rKzEpLCBpbmRleDogaW5kZXh9KVxuICAgICAgICAgICAgICAgfVxuICAgICAgICAgICB9KTtcblxuICAgICAgICAgICBpZih0ZXJtTGlzdC5sZW5ndGg+MCl7XG4gICAgICAgICAgICAgcmV0dXJuIHRoaXMuZG9OdW1lcmljYWxTb3J0KCB0ZXJtTGlzdCwgJ3JhbmsnKTtcbiAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgcmV0dXJuIHRlcm1MaXN0O1xuICAgICAgICAgICB9XG5cbiAgICAgfVxuXG4gICAgcHJpdmF0ZSBzb3J0Q29sbGVjdGlvbigpe1xuICAgICAgIGlmKFNPUlRfQkFTRVNbdGhpcy5zb3J0U3RhdGVWYWwuc29ydEJhc2VdLmRhdGFUeXBlID09PSBcInN0cmluZ1wiKXtcbiAgICAgICAgICB0aGlzLmdhcm1lbnRQcm9kdWN0cyA9IHRoaXMuZG9BbHBoYVNvcnQodGhpcy5nYXJtZW50UHJvZHVjdHMsICBTT1JUX0JBU0VTW3RoaXMuc29ydFN0YXRlVmFsLnNvcnRCYXNlXS5hdHRyKTtcbiAgICAgICAgICBpZiggIHRoaXMuc29ydFN0YXRlVmFsLnNvcnREaXJlY3Rpb24gPT0gXCJEZXNjZW5kaW5nXCIpe1xuICAgICAgICAgICAgIHRoaXMuZ2FybWVudFByb2R1Y3RzID0gdGhpcy5nYXJtZW50UHJvZHVjdHMucmV2ZXJzZSgpO1xuICAgICAgICAgIH1cbiAgICAgICB9ZWxzZSBpZihTT1JUX0JBU0VTWyAgdGhpcy5zb3J0U3RhdGVWYWwuc29ydEJhc2VdLmRhdGFUeXBlID09PSBcIm51bWJlclwiKXtcbiAgICAgICAgICB0aGlzLmdhcm1lbnRQcm9kdWN0cyA9IHRoaXMuZG9OdW1lcmljYWxTb3J0KHRoaXMuZ2FybWVudFByb2R1Y3RzLCAgIFNPUlRfQkFTRVNbdGhpcy5zb3J0U3RhdGVWYWwuc29ydEJhc2VdLmF0dHIpO1xuICAgICAgICAgIGlmKCAgdGhpcy5zb3J0U3RhdGVWYWwuc29ydERpcmVjdGlvbiA9PSBcIkRlc2NlbmRpbmdcIil7XG4gICAgICAgICAgICAgdGhpcy5nYXJtZW50UHJvZHVjdHMgPSB0aGlzLmdhcm1lbnRQcm9kdWN0cy5yZXZlcnNlKCk7XG4gICAgICAgICAgfVxuICAgICAgIH1lbHNle1xuICAgICAgICAgIHRoaXMuZ2FybWVudFByb2R1Y3RzID0gdGhpcy5kb1R5cGVTb3J0KHRoaXMuZ2FybWVudFByb2R1Y3RzLCAgIFNPUlRfQkFTRVNbdGhpcy5zb3J0U3RhdGVWYWwuc29ydEJhc2VdLmF0dHIpO1xuXG4gICAgICAgfVxuICAgICAgIHJldHVybiB0aGlzLmdhcm1lbnRQcm9kdWN0cztcbiAgICB9XG5cblxuICAgIHByaXZhdGUgc2V0TW9zdEN1cnJlbnRTdG9yZVZhbHVlcygpe1xuXG4gICAgICAgIHRoaXMuZ2FybWVudFN0b3JlJCA9IHRoaXMuc3RvcmUuc2VsZWN0KGZyb21Sb290LmdldEdhcm1lbnRzU3RhdGUpLnN1YnNjcmliZSgodmFsKT0+e1xuICAgICAgICAgICAgdGhpcy5jb2xsZWN0aW9uSWQgPSB2YWwuY3VycmVudENvbGxlY3Rpb25JZDtcbiAgICAgICAgICAgIHRoaXMuY3VycmVudEdhcm1lbnRDb2xsZWN0aW9uID0gdmFsLmVudGl0aWVzW3RoaXMuY29sbGVjdGlvbklkXTtcbiAgICAgICAgICAgIHRoaXMuZ2FybWVudFByb2R1Y3RzID0gIHRoaXMuY3VycmVudEdhcm1lbnRDb2xsZWN0aW9uLnByb2R1Y3RzO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5nYXJtZW50U3RvcmUkLnVuc3Vic2NyaWJlKCk7XG5cbiAgICAgICAgdGhpcy5zb3J0U3RhdGUkPSB0aGlzLnN0b3JlLnNlbGVjdChmcm9tUm9vdC5nZXRQb3J0YWxTdGF0ZSkuc3Vic2NyaWJlKCh2YWwpPT57XG4gICAgICAgICAgICB0aGlzLnNvcnRTdGF0ZVZhbCA9IHZhbDtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuc29ydFN0YXRlJC51bnN1YnNjcmliZSgpO1xuICAgIH1cbiAgICAgICAgXG4gICAgcHJpdmF0ZSBkb0FscGhhU29ydChsaXN0OmFueSwgYmFzZTpzdHJpbmcpe1xuICAgICAgICAgICAgbGV0IHZhbHVlOmFueSA9IFsuLi5saXN0XS5zb3J0KChmaXJzdFRlcm0sIHNlY29uZFRlcm0pOm51bWJlciA9PntcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYSA9IGZpcnN0VGVybVtiYXNlXS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBiID0gc2Vjb25kVGVybVtiYXNlXS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoYSA+IGIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGEgPCBiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gLTE7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH1cblxuICAgIHByaXZhdGUgZG9OdW1lcmljYWxTb3J0KGxpc3Q6YW55LCBiYXNlOnN0cmluZyl7XG4gICAgICAgIHJldHVybiAgWy4uLmxpc3RdLnNvcnQoKGZpcnN0VGVybSwgc2Vjb25kVGVybSkgPT57XG4gICAgICAgICAgICByZXR1cm4gKGZpcnN0VGVybVtiYXNlXSAtIChzZWNvbmRUZXJtKVtiYXNlXSlcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkb1R5cGVTb3J0KGxpc3Q6R2FybWVudE1vZGVsW10gLCB0eXBlOnN0cmluZyl7XG4gICAgICBsZXQgUGh5c2ljYWw6R2FybWVudE1vZGVsW10gPSBbXTtcbiAgICAgIGxldCBEaWdpdGFsOkdhcm1lbnRNb2RlbFtdICA9IFtdO1xuICAgICAgbGV0IFNlcnZpY2U6R2FybWVudE1vZGVsW10gID0gW107XG5cbiAgICAgIGxpc3QuZm9yRWFjaCggKGl0ZW0pPT57XG4gICAgICAgICAgc3dpdGNoKGl0ZW0udHlwZSl7XG4gICAgICAgICAgICAgIGNhc2UgXCJQaHlzaWNhbFwiOlxuICAgICAgICAgICAgICAgIFBoeXNpY2FsLnB1c2goaXRlbSk7XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICBjYXNlIFwiRGlnaXRhbFwiOlxuICAgICAgICAgICAgICAgIERpZ2l0YWwucHVzaChpdGVtKTtcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgIGNhc2UgXCJTZXJ2aWNlXCI6XG4gICAgICAgICAgICAgICAgU2VydmljZS5wdXNoKGl0ZW0pO1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgbGV0IHR5cGVTb3J0ZWQ6R2FybWVudE1vZGVsW10gO1xuXG4gICAgICBzd2l0Y2godHlwZSl7XG4gICAgICAgICAgY2FzZSBcIlBoeXNpY2FsXCI6XG4gICAgICAgICAgICAgIHR5cGVTb3J0ZWQ9IFsuLi5QaHlzaWNhbCwuLi5EaWdpdGFsLCAuLi5TZXJ2aWNlXTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlIFwiRGlnaXRhbFwiOlxuICAgICAgICAgICAgICB0eXBlU29ydGVkPSBbLi4uRGlnaXRhbCwuLi5QaHlzaWNhbCwgLi4uU2VydmljZV07XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSBcIlNlcnZpY2VcIjpcbiAgICAgICAgICAgICAgdHlwZVNvcnRlZD0gWy4uLlNlcnZpY2UsLi4uUGh5c2ljYWwsIC4uLkRpZ2l0YWxdO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHR5cGVTb3J0ZWQ7XG4gICAgfVxuXG5cbiAgICBwcml2YXRlIG1vdmVFbGVtZW50c0luTGlzdChjcm50SW5kZXg6bnVtYmVyLCBuZXdJbmRleDpudW1iZXIsIGxpc3Q6YW55W10pe1xuICAgICAgICBsaXN0LnNwbGljZShuZXdJbmRleCwgMCwgbGlzdC5zcGxpY2UoY3JudEluZGV4LCAxKVswXSk7XG4gICAgfVxuXG5cbiAgICBwcml2YXRlIGNyZWF0ZUdhcm1lbnRTdWJTZXQoKXtcbiAgICAgICAgY29uc3QgcGFnZXMgPSBNYXRoLmNlaWwodGhpcy5nYXJtZW50UHJvZHVjdHMubGVuZ3RoIC8gdGhpcy5zb3J0U3RhdGVWYWwudmlld2FibGVQZXJQYWdlKTtcbiAgICAgICAgY29uc3Qgc3RhcnQgPSAodGhpcy5zb3J0U3RhdGVWYWwuY3VycmVudFBhZ2UgLSAxKSAqIHRoaXMuc29ydFN0YXRlVmFsLnZpZXdhYmxlUGVyUGFnZTtcbiAgICAgICAgY29uc3QgZW5kID0gKHRoaXMuc29ydFN0YXRlVmFsLmN1cnJlbnRQYWdlID09PSBwYWdlcykgP1xuICAgICAgICAgICAgdGhpcy5nYXJtZW50UHJvZHVjdHMubGVuZ3RoIDpcbiAgICAgICAgICAgIHRoaXMuc29ydFN0YXRlVmFsLnZpZXdhYmxlUGVyUGFnZSAqIHRoaXMuc29ydFN0YXRlVmFsLmN1cnJlbnRQYWdlO1xuICAgICAgICByZXR1cm4gdGhpcy5nYXJtZW50UHJvZHVjdHMuc2xpY2Uoc3RhcnQsIGVuZCk7XG4gICAgfVxuXG5cbn0iXX0=
