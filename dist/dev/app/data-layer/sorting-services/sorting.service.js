"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var store_1 = require("@ngrx/store");
var Observable_1 = require("rxjs/Observable");
require("rxjs/add/observable/of");
var fromRoot = require("../ngrx-data/reducers/index");
var sort_config_types_1 = require("../../business-layer/shared-types/sorters/sort.config.types");
var SortingServices = (function () {
    function SortingServices(store) {
        this.store = store;
    }
    SortingServices.prototype.getCollectionSubset = function () {
        this.setMostCurrentStoreValues();
        var collectionSubset = this.createGarmentSubSet();
        return Observable_1.Observable.of({ collectionId: this.collectionId,
            sortType: this.sortStateVal.sortType,
            subSetCollection: collectionSubset,
            products: this.garmentProducts });
    };
    SortingServices.prototype.sortGarmentCollection = function () {
        this.setMostCurrentStoreValues();
        this.sortCollection();
        var collectionSubset = this.createGarmentSubSet();
        return Observable_1.Observable.of({ collectionId: this.collectionId,
            sortType: this.sortStateVal.sortType,
            subSetCollection: collectionSubset,
            products: this.garmentProducts });
    };
    SortingServices.prototype.searchGarmentCollection = function (searchTerm) {
        var _this = this;
        this.setMostCurrentStoreValues();
        var termsInset = this.findTermsInCollectionNames(searchTerm);
        var clonedGM = this.garmentProducts.slice();
        termsInset.forEach(function (item, index) {
            _this.moveElementsInList(item.index, index, clonedGM);
        });
        return Observable_1.Observable.of({ collectionId: this.collectionId,
            sortType: this.sortStateVal.sortType,
            subSetCollection: clonedGM,
            products: this.garmentProducts });
    };
    SortingServices.prototype.findTermsInCollectionNames = function (searchTerm) {
        var stringObjects = { rank: -1, index: -1 };
        var termList = [];
        this.garmentProducts.forEach(function (item, index) {
            var rank = item.name.search(searchTerm);
            if (rank > -1) {
                termList.push({ rank: (rank + 1), index: index });
            }
        });
        if (termList.length > 0) {
            return this.doNumericalSort(termList, 'rank');
        }
        else {
            return termList;
        }
    };
    SortingServices.prototype.sortCollection = function () {
        if (sort_config_types_1.SORT_BASES[this.sortStateVal.sortBase].dataType === 'string') {
            this.garmentProducts = this.doAlphaSort(this.garmentProducts, sort_config_types_1.SORT_BASES[this.sortStateVal.sortBase].attr);
            if (this.sortStateVal.sortDirection == 'Descending') {
                this.garmentProducts = this.garmentProducts.reverse();
            }
        }
        else if (sort_config_types_1.SORT_BASES[this.sortStateVal.sortBase].dataType === 'number') {
            this.garmentProducts = this.doNumericalSort(this.garmentProducts, sort_config_types_1.SORT_BASES[this.sortStateVal.sortBase].attr);
            if (this.sortStateVal.sortDirection == 'Descending') {
                this.garmentProducts = this.garmentProducts.reverse();
            }
        }
        else {
            this.garmentProducts = this.doTypeSort(this.garmentProducts, sort_config_types_1.SORT_BASES[this.sortStateVal.sortBase].attr);
        }
        return this.garmentProducts;
    };
    SortingServices.prototype.setMostCurrentStoreValues = function () {
        var _this = this;
        this.garmentStore$ = this.store.select(fromRoot.getGarmentsState).subscribe(function (val) {
            _this.collectionId = val.currentCollectionId;
            _this.currentGarmentCollection = val.entities[_this.collectionId];
            _this.garmentProducts = _this.currentGarmentCollection.products;
        });
        this.garmentStore$.unsubscribe();
        this.sortState$ = this.store.select(fromRoot.getPortalState).subscribe(function (val) {
            _this.sortStateVal = val;
        });
        this.sortState$.unsubscribe();
    };
    SortingServices.prototype.doAlphaSort = function (list, base) {
        var value = list.slice().sort(function (firstTerm, secondTerm) {
            var a = firstTerm[base].toLowerCase();
            var b = secondTerm[base].toLowerCase();
            if (a > b) {
                return 1;
            }
            if (a < b) {
                return -1;
            }
            return 0;
        });
        return value;
    };
    SortingServices.prototype.doNumericalSort = function (list, base) {
        return list.slice().sort(function (firstTerm, secondTerm) {
            return (firstTerm[base] - (secondTerm)[base]);
        });
    };
    SortingServices.prototype.doTypeSort = function (list, type) {
        var Physical = [];
        var Digital = [];
        var Service = [];
        list.forEach(function (item) {
            switch (item.type) {
                case 'Physical':
                    Physical.push(item);
                    break;
                case 'Digital':
                    Digital.push(item);
                    break;
                case 'Service':
                    Service.push(item);
                    break;
            }
        });
        var typeSorted;
        switch (type) {
            case 'Physical':
                typeSorted = Physical.concat(Digital, Service);
                break;
            case 'Digital':
                typeSorted = Digital.concat(Physical, Service);
                break;
            case 'Service':
                typeSorted = Service.concat(Physical, Digital);
                break;
        }
        return typeSorted;
    };
    SortingServices.prototype.moveElementsInList = function (crntIndex, newIndex, list) {
        list.splice(newIndex, 0, list.splice(crntIndex, 1)[0]);
    };
    SortingServices.prototype.createGarmentSubSet = function () {
        var pages = Math.ceil(this.garmentProducts.length / this.sortStateVal.viewablePerPage);
        var start = (this.sortStateVal.currentPage - 1) * this.sortStateVal.viewablePerPage;
        var end = (this.sortStateVal.currentPage === pages) ?
            this.garmentProducts.length :
            this.sortStateVal.viewablePerPage * this.sortStateVal.currentPage;
        return this.garmentProducts.slice(start, end);
    };
    return SortingServices;
}());
SortingServices = __decorate([
    core_1.Injectable(),
    __metadata("design:paramtypes", [store_1.Store])
], SortingServices);
exports.SortingServices = SortingServices;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC9kYXRhLWxheWVyL3NvcnRpbmctc2VydmljZXMvc29ydGluZy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBR0Esc0NBQXlDO0FBQ3pDLHFDQUFvQztBQUVwQyw4Q0FBNkM7QUFDN0Msa0NBQWdDO0FBQ2hDLHNEQUF3RDtBQUV4RCxpR0FBMEY7QUFHMUYsSUFBYSxlQUFlO0lBVXhCLHlCQUFxQixLQUE0QjtRQUE1QixVQUFLLEdBQUwsS0FBSyxDQUF1QjtJQUFFLENBQUM7SUFFcEQsNkNBQW1CLEdBQW5CO1FBQ0ksSUFBSSxDQUFDLHlCQUF5QixFQUFFLENBQUM7UUFDakMsSUFBSSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztRQUNsRCxNQUFNLENBQUMsdUJBQVUsQ0FBQyxFQUFFLENBQW1CLEVBQUcsWUFBWSxFQUFDLElBQUksQ0FBQyxZQUFZO1lBQ3BFLFFBQVEsRUFBQyxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVE7WUFDbkMsZ0JBQWdCLEVBQUMsZ0JBQWdCO1lBQ2pDLFFBQVEsRUFBQyxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUMsQ0FBQTtJQUN4QyxDQUFDO0lBRUQsK0NBQXFCLEdBQXJCO1FBQ0ksSUFBSSxDQUFDLHlCQUF5QixFQUFFLENBQUM7UUFDakMsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQ3RCLElBQUksZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7UUFDbEQsTUFBTSxDQUFDLHVCQUFVLENBQUMsRUFBRSxDQUFtQixFQUFHLFlBQVksRUFBQyxJQUFJLENBQUMsWUFBWTtZQUM5QixRQUFRLEVBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRO1lBQ25DLGdCQUFnQixFQUFDLGdCQUFnQjtZQUNqQyxRQUFRLEVBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDLENBQUM7SUFDOUUsQ0FBQztJQUVGLGlEQUF1QixHQUF2QixVQUF3QixV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ZSxDQUFDLENBQUM7UUFDekYsSUFBTSxLQUFLLEdBQUcsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsR0FBRyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLGVBQWUsQ0FBQztRQUN0RixJQUFNLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxLQUFLLEtBQUssQ0FBQztZQUNqRCxJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU07WUFDM0IsSUFBSSxDQUFDLFlBQVksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUM7UUFDdEUsTUFBTSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztJQUNsRCxDQUFDO0lBQ0wsc0JBQUM7QUFBRCxDQXJLQSxBQXFLQyxJQUFBO0FBcktZLGVBQWU7SUFEM0IsaUJBQVUsRUFBRTtxQ0FXbUIsYUFBSztHQVZ4QixlQUFlLENBcUszQjtBQXJLWSwwQ0FBZSIsImZpbGUiOiJhcHAvZGF0YS1sYXllci9zb3J0aW5nLXNlcnZpY2VzL3NvcnRpbmcuc2VydmljZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ3JlYXRlZCBieSB3aWxsc3RyZWV0ZXIgb24gOS84LzE3LlxuICovXG5pbXBvcnQge0luamVjdGFibGV9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgU3RvcmUgfSBmcm9tICdAbmdyeC9zdG9yZSc7XG5pbXBvcnQgeyBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzL1N1YnNjcmlwdGlvbic7XG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcy9PYnNlcnZhYmxlJztcbmltcG9ydCAncnhqcy9hZGQvb2JzZXJ2YWJsZS9vZic7XG5pbXBvcnQgKiBhcyBmcm9tUm9vdCBmcm9tICcuLi9uZ3J4LWRhdGEvcmVkdWNlcnMvaW5kZXgnO1xuaW1wb3J0IHsgR2FybWVudE1vZGVsLCBHYXJtZW50Q29sbGVjdGlvbk1vZGVsLCBHYXJtZW50U29ydE1vZGVsIH0gZnJvbSAnLi4vLi4vYnVzaW5lc3MtbGF5ZXIvbW9kZWxzL2luZGV4JztcbmltcG9ydCB7IFNPUlRfQkFTRVMgIH0gZnJvbSAnLi4vLi4vYnVzaW5lc3MtbGF5ZXIvc2hhcmVkLXR5cGVzL3NvcnRlcnMvc29ydC5jb25maWcudHlwZXMnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgU29ydGluZ1NlcnZpY2VzIHtcbiAgICBwcml2YXRlIHNvcnRTdGF0ZSQ6U3Vic2NyaXB0aW9uO1xuICAgIHByaXZhdGUgZ2FybWVudFN0b3JlJDpTdWJzY3JpcHRpb247XG4gICAgcHJpdmF0ZSBjdXJyZW50R2FybWVudENvbGxlY3Rpb246R2FybWVudENvbGxlY3Rpb25Nb2RlbDtcbiAgICBwcml2YXRlIGdhcm1lbnRQcm9kdWN0czpHYXJtZW50TW9kZWxbXTtcbiAgICBwcml2YXRlIHNvcnRTdGF0ZVZhbDphbnk7XG4gICAgcHJpdmF0ZSBjdXJyZW50UGFnZTphbnk7XG4gICAgcHJpdmF0ZSB2aWV3YWJsZVBlclBhZ2U6YW55O1xuICAgIHByaXZhdGUgY29sbGVjdGlvbklkOnN0cmluZztcblxuICAgIGNvbnN0cnVjdG9yKCBwcml2YXRlIHN0b3JlOiBTdG9yZTxmcm9tUm9vdC5TdGF0ZT4pe31cblxuICAgIGdldENvbGxlY3Rpb25TdWJzZXQoKXtcbiAgICAgICAgdGhpcy5zZXRNb3N0Q3VycmVudFN0b3JlVmFsdWVzKCk7XG4gICAgICAgIGxldCBjb2xsZWN0aW9uU3Vic2V0ID0gdGhpcy5jcmVhdGVHYXJtZW50U3ViU2V0KCk7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLm9mKDxHYXJtZW50U29ydE1vZGVsPnsgIGNvbGxlY3Rpb25JZDp0aGlzLmNvbGxlY3Rpb25JZCxcbiAgICAgICAgICAgIHNvcnRUeXBlOnRoaXMuc29ydFN0YXRlVmFsLnNvcnRUeXBlLFxuICAgICAgICAgICAgc3ViU2V0Q29sbGVjdGlvbjpjb2xsZWN0aW9uU3Vic2V0LFxuICAgICAgICAgICAgcHJvZHVjdHM6dGhpcy5nYXJtZW50UHJvZHVjdHMgfSlcbiAgICB9XG5cbiAgICBzb3J0R2FybWVudENvbGxlY3Rpb24oKXtcbiAgICAgICAgdGhpcy5zZXRNb3N0Q3VycmVudFN0b3JlVmFsdWVzKCk7XG4gICAgICAgIHRoaXMuc29ydENvbGxlY3Rpb24oKTtcbiAgICAgICAgbGV0IGNvbGxlY3Rpb25TdWJzZXQgPSB0aGlzLmNyZWF0ZUdhcm1lbnRTdWJTZXQoKTtcbiAgICAgICAgcmV0dXJuIE9ic2VydmFibGUub2YoPEdhcm1lbnRTb3J0TW9kZWw+eyAgY29sbGVjdGlvbklkOnRoaXMuY29sbGVjdGlvbklkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzb3J0VHlwZTp0aGlzLnNvcnRTdGF0ZVZhbC5zb3J0VHlwZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ViU2V0Q29sbGVjdGlvbjpjb2xsZWN0aW9uU3Vic2V0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9kdWN0czp0aGlzLmdhcm1lbnRQcm9kdWN0cyB9KTtcbiAgICAgfVxuXG4gICAgc2VhcmNoR2FybWVudENvbGxlY3Rpb24oc2VhcmNoVGVybTpzdHJpbmcpe1xuICAgICAgICAgdGhpcy5zZXRNb3N0Q3VycmVudFN0b3JlVmFsdWVzKCk7XG4gICAgICAgICBsZXQgdGVybXNJbnNldDphbnlbXSA9IHRoaXMuZmluZFRlcm1zSW5Db2xsZWN0aW9uTmFtZXMoc2VhcmNoVGVybSk7XG4gICAgICAgICBsZXQgY2xvbmVkR006R2FybWVudE1vZGVsW10gPSBbLi4udGhpcy5nYXJtZW50UHJvZHVjdHNdO1xuICAgICAgICAgdGVybXNJbnNldC5mb3JFYWNoKCAoaXRlbSwgaW5kZXgpPT57XG4gICAgICAgICAgICAgdGhpcy5tb3ZlRWxlbWVudHNJbkxpc3QoaXRlbS5pbmRleCwgaW5kZXgsIGNsb25lZEdNKVxuICAgICAgICAgfSk7XG4gICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5vZig8R2FybWVudFNvcnRNb2RlbD57ICBjb2xsZWN0aW9uSWQ6dGhpcy5jb2xsZWN0aW9uSWQsXG4gICAgICAgICAgICAgc29ydFR5cGU6dGhpcy5zb3J0U3RhdGVWYWwuc29ydFR5cGUsXG4gICAgICAgICAgICAgc3ViU2V0Q29sbGVjdGlvbjpjbG9uZWRHTSxcbiAgICAgICAgICAgICBwcm9kdWN0czp0aGlzLmdhcm1lbnRQcm9kdWN0cyB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGZpbmRUZXJtc0luQ29sbGVjdGlvbk5hbWVzKHNlYXJjaFRlcm06c3RyaW5nKXtcbiAgICAgICAgICAgbGV0IHN0cmluZ09iamVjdHM6YW55ID0geyByYW5rOi0xLCBpbmRleDotMSAgfTtcbiAgICAgICAgICAgbGV0IHRlcm1MaXN0ID0gW107XG4gICAgICAgICAgIHRoaXMuZ2FybWVudFByb2R1Y3RzLmZvckVhY2goKGl0ZW0sIGluZGV4KT0+IHtcbiAgICAgICAgICAgICAgIGNvbnN0IHJhbms6IG51bWJlciA9IGl0ZW0ubmFtZS5zZWFyY2goc2VhcmNoVGVybSk7XG4gICAgICAgICAgICAgICBpZiAocmFuayA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgdGVybUxpc3QucHVzaCh7cmFuazogKHJhbmsrMSksIGluZGV4OiBpbmRleH0pXG4gICAgICAgICAgICAgICB9XG4gICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgIGlmKHRlcm1MaXN0Lmxlbmd0aD4wKXtcbiAgICAgICAgICAgICByZXR1cm4gdGhpcy5kb051bWVyaWNhbFNvcnQoIHRlcm1MaXN0LCAncmFuaycpO1xuICAgICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgICByZXR1cm4gdGVybUxpc3Q7XG4gICAgICAgICAgIH1cblxuICAgICB9XG5cbiAgICBwcml2YXRlIHNvcnRDb2xsZWN0aW9uKCl7XG4gICAgICAgaWYoU09SVF9CQVNFU1t0aGlzLnNvcnRTdGF0ZVZhbC5zb3J0QmFzZV0uZGF0YVR5cGUgPT09ICdzdHJpbmcnKXtcbiAgICAgICAgICB0aGlzLmdhcm1lbnRQcm9kdWN0cyA9IHRoaXMuZG9BbHBoYVNvcnQodGhpcy5nYXJtZW50UHJvZHVjdHMsICBTT1JUX0JBU0VTW3RoaXMuc29ydFN0YXRlVmFsLnNvcnRCYXNlXS5hdHRyKTtcbiAgICAgICAgICBpZiggIHRoaXMuc29ydFN0YXRlVmFsLnNvcnREaXJlY3Rpb24gPT0gJ0Rlc2NlbmRpbmcnKXtcbiAgICAgICAgICAgICB0aGlzLmdhcm1lbnRQcm9kdWN0cyA9IHRoaXMuZ2FybWVudFByb2R1Y3RzLnJldmVyc2UoKTtcbiAgICAgICAgICB9XG4gICAgICAgfWVsc2UgaWYoU09SVF9CQVNFU1sgIHRoaXMuc29ydFN0YXRlVmFsLnNvcnRCYXNlXS5kYXRhVHlwZSA9PT0gJ251bWJlcicpe1xuICAgICAgICAgIHRoaXMuZ2FybWVudFByb2R1Y3RzID0gdGhpcy5kb051bWVyaWNhbFNvcnQodGhpcy5nYXJtZW50UHJvZHVjdHMsICAgU09SVF9CQVNFU1t0aGlzLnNvcnRTdGF0ZVZhbC5zb3J0QmFzZV0uYXR0cik7XG4gICAgICAgICAgaWYoICB0aGlzLnNvcnRTdGF0ZVZhbC5zb3J0RGlyZWN0aW9uID09ICdEZXNjZW5kaW5nJyl7XG4gICAgICAgICAgICAgdGhpcy5nYXJtZW50UHJvZHVjdHMgPSB0aGlzLmdhcm1lbnRQcm9kdWN0cy5yZXZlcnNlKCk7XG4gICAgICAgICAgfVxuICAgICAgIH1lbHNle1xuICAgICAgICAgIHRoaXMuZ2FybWVudFByb2R1Y3RzID0gdGhpcy5kb1R5cGVTb3J0KHRoaXMuZ2FybWVudFByb2R1Y3RzLCAgIFNPUlRfQkFTRVNbdGhpcy5zb3J0U3RhdGVWYWwuc29ydEJhc2VdLmF0dHIpO1xuXG4gICAgICAgfVxuICAgICAgIHJldHVybiB0aGlzLmdhcm1lbnRQcm9kdWN0cztcbiAgICB9XG5cbiAgICBwcml2YXRlIHNldE1vc3RDdXJyZW50U3RvcmVWYWx1ZXMoKXtcblxuICAgICAgICB0aGlzLmdhcm1lbnRTdG9yZSQgPSB0aGlzLnN0b3JlLnNlbGVjdChmcm9tUm9vdC5nZXRHYXJtZW50c1N0YXRlKS5zdWJzY3JpYmUoKHZhbCk9PntcbiAgICAgICAgICAgIHRoaXMuY29sbGVjdGlvbklkID0gdmFsLmN1cnJlbnRDb2xsZWN0aW9uSWQ7XG4gICAgICAgICAgICB0aGlzLmN1cnJlbnRHYXJtZW50Q29sbGVjdGlvbiA9IHZhbC5lbnRpdGllc1t0aGlzLmNvbGxlY3Rpb25JZF07XG4gICAgICAgICAgICB0aGlzLmdhcm1lbnRQcm9kdWN0cyA9ICB0aGlzLmN1cnJlbnRHYXJtZW50Q29sbGVjdGlvbi5wcm9kdWN0cztcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuZ2FybWVudFN0b3JlJC51bnN1YnNjcmliZSgpO1xuXG4gICAgICAgIHRoaXMuc29ydFN0YXRlJD0gdGhpcy5zdG9yZS5zZWxlY3QoZnJvbVJvb3QuZ2V0UG9ydGFsU3RhdGUpLnN1YnNjcmliZSgodmFsKT0+e1xuICAgICAgICAgICAgdGhpcy5zb3J0U3RhdGVWYWwgPSB2YWw7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnNvcnRTdGF0ZSQudW5zdWJzY3JpYmUoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGRvQWxwaGFTb3J0KGxpc3Q6YW55LCBiYXNlOnN0cmluZyl7XG4gICAgICAgICAgICBsZXQgdmFsdWU6YW55ID0gWy4uLmxpc3RdLnNvcnQoKGZpcnN0VGVybSwgc2Vjb25kVGVybSk6bnVtYmVyID0+e1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBhID0gZmlyc3RUZXJtW2Jhc2VdLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGIgPSBzZWNvbmRUZXJtW2Jhc2VdLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhID4gYikge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBpZiAoYSA8IGIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAtMTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAwO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICByZXR1cm4gdmFsdWU7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkb051bWVyaWNhbFNvcnQobGlzdDphbnksIGJhc2U6c3RyaW5nKXtcbiAgICAgICAgcmV0dXJuICBbLi4ubGlzdF0uc29ydCgoZmlyc3RUZXJtLCBzZWNvbmRUZXJtKSA9PntcbiAgICAgICAgICAgIHJldHVybiAoZmlyc3RUZXJtW2Jhc2VdIC0gKHNlY29uZFRlcm0pW2Jhc2VdKVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGRvVHlwZVNvcnQobGlzdDpHYXJtZW50TW9kZWxbXSAsIHR5cGU6c3RyaW5nKXtcbiAgICAgIGxldCBQaHlzaWNhbDpHYXJtZW50TW9kZWxbXSA9IFtdO1xuICAgICAgbGV0IERpZ2l0YWw6R2FybWVudE1vZGVsW10gID0gW107XG4gICAgICBsZXQgU2VydmljZTpHYXJtZW50TW9kZWxbXSAgPSBbXTtcblxuICAgICAgbGlzdC5mb3JFYWNoKCAoaXRlbSk9PntcbiAgICAgICAgICBzd2l0Y2goaXRlbS50eXBlKXtcbiAgICAgICAgICAgICAgY2FzZSAnUGh5c2ljYWwnOlxuICAgICAgICAgICAgICAgIFBoeXNpY2FsLnB1c2goaXRlbSk7XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICBjYXNlICdEaWdpdGFsJzpcbiAgICAgICAgICAgICAgICBEaWdpdGFsLnB1c2goaXRlbSk7XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICBjYXNlICdTZXJ2aWNlJzpcbiAgICAgICAgICAgICAgICBTZXJ2aWNlLnB1c2goaXRlbSk7XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgIH0pO1xuXG4gICAgICBsZXQgdHlwZVNvcnRlZDpHYXJtZW50TW9kZWxbXSA7XG5cbiAgICAgIHN3aXRjaCh0eXBlKXtcbiAgICAgICAgICBjYXNlICdQaHlzaWNhbCc6XG4gICAgICAgICAgICAgIHR5cGVTb3J0ZWQ9IFsuLi5QaHlzaWNhbCwuLi5EaWdpdGFsLCAuLi5TZXJ2aWNlXTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlICdEaWdpdGFsJzpcbiAgICAgICAgICAgICAgdHlwZVNvcnRlZD0gWy4uLkRpZ2l0YWwsLi4uUGh5c2ljYWwsIC4uLlNlcnZpY2VdO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgJ1NlcnZpY2UnOlxuICAgICAgICAgICAgICB0eXBlU29ydGVkPSBbLi4uU2VydmljZSwuLi5QaHlzaWNhbCwgLi4uRGlnaXRhbF07XG4gICAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICByZXR1cm4gdHlwZVNvcnRlZDtcbiAgICB9XG5cbiAgICBwcml2YXRlIG1vdmVFbGVtZW50c0luTGlzdChjcm50SW5kZXg6bnVtYmVyLCBuZXdJbmRleDpudW1iZXIsIGxpc3Q6YW55W10pe1xuICAgICAgICBsaXN0LnNwbGljZShuZXdJbmRleCwgMCwgbGlzdC5zcGxpY2UoY3JudEluZGV4LCAxKVswXSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjcmVhdGVHYXJtZW50U3ViU2V0KCl7XG4gICAgICAgIGNvbnN0IHBhZ2VzID0gTWF0aC5jZWlsKHRoaXMuZ2FybWVudFByb2R1Y3RzLmxlbmd0aCAvIHRoaXMuc29ydFN0YXRlVmFsLnZpZXdhYmxlUGVyUGFnZSk7XG4gICAgICAgIGNvbnN0IHN0YXJ0ID0gKHRoaXMuc29ydFN0YXRlVmFsLmN1cnJlbnRQYWdlIC0gMSkgKiB0aGlzLnNvcnRTdGF0ZVZhbC52aWV3YWJsZVBlclBhZ2U7XG4gICAgICAgIGNvbnN0IGVuZCA9ICh0aGlzLnNvcnRTdGF0ZVZhbC5jdXJyZW50UGFnZSA9PT0gcGFnZXMpID9cbiAgICAgICAgICAgIHRoaXMuZ2FybWVudFByb2R1Y3RzLmxlbmd0aCA6XG4gICAgICAgICAgICB0aGlzLnNvcnRTdGF0ZVZhbC52aWV3YWJsZVBlclBhZ2UgKiB0aGlzLnNvcnRTdGF0ZVZhbC5jdXJyZW50UGFnZTtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2FybWVudFByb2R1Y3RzLnNsaWNlKHN0YXJ0LCBlbmQpO1xuICAgIH1cbn1cbiJdfQ==
