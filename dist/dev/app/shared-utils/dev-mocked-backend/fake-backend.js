"use strict";
var __extends = (this && this.__extends) || (function () {
    var extendStatics = Object.setPrototypeOf ||
        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
var http_1 = require("@angular/http");
var testing_1 = require("@angular/http/testing");
var MockError = (function (_super) {
    __extends(MockError, _super);
    function MockError() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    return MockError;
}(http_1.Response));
function fakeBackendFactory(backend, options, realBackend) {
    var users = JSON.parse(localStorage.getItem('users')) || [];
    backend.connections.subscribe(function (connection) {
        setTimeout(function () {
            if (connection.request.url.endsWith('api/Authorizations/Login') &&
                connection.request.method === http_1.RequestMethod.Post) {
                var params_1 = JSON.parse(connection.request.getBody());
                if (!localStorage.getItem('users') && params_1.username === 'taobing') {
                    localStorage.setItem('users', JSON.stringify({
                        id: '12345',
                        username: 'taobing',
                        password: 'password',
                        firstname: 'Thor',
                        lastname: 'Newssen',
                        email: 'tn@gm.com',
                        token: '12345-fake-jwt-token'
                    }));
                    users = [JSON.parse(localStorage.getItem('users'))];
                }
                var filteredUsers = users.filter(function (user) {
                    return user.username === params_1.username && user.password === params_1.password;
                });
                if (filteredUsers.length) {
                    var aUser = filteredUsers[0];
                    connection.mockRespond(new http_1.Response(new http_1.ResponseOptions({
                        status: 200,
                        body: { account: {
                                user: aUser,
                                token: aUser.token
                            }
                        }
                    })));
                }
                else {
                    var body = JSON.stringify({ error: 'Username or password is incorrect' });
                    var opts = { type: http_1.ResponseType.Error, status: 400, body: body };
                    var responseOpts = new http_1.ResponseOptions(opts);
                    connection.mockError(new MockError(responseOpts));
                }
                return;
            }
            if (connection.request.url.endsWith('api/Authorizations/Logout') &&
                connection.request.method === http_1.RequestMethod.Post) {
                var userOut = { status: 200,
                    general: {
                        message: 'user logged out',
                        success: true
                    }
                };
                connection.mockRespond(new http_1.Response(new http_1.ResponseOptions({ status: 200, body: userOut })));
                return;
            }
            if (connection.request.url.match(/\/api\/Users\/username\/\w+$/) &&
                connection.request.method === http_1.RequestMethod.Get) {
                var urlParts = connection.request.url.split('/');
                var username_1 = urlParts[urlParts.length - 1];
                if (!localStorage.getItem('users') && username_1 === 'taobing') {
                    localStorage.setItem('users', JSON.stringify({
                        id: '12345',
                        username: 'taobing',
                        password: 'password',
                        firstname: 'Thor',
                        lastname: 'Newssen',
                        email: 'tn@gm.com',
                        token: '12345-fake-jwt-token'
                    }));
                    users = [JSON.parse(localStorage.getItem('users'))];
                }
                var duplicateUser = users.filter(function (user) { return user.username === username_1; });
                if (duplicateUser && duplicateUser.length > 0) {
                    connection.mockRespond(new http_1.Response(new http_1.ResponseOptions({
                        status: 200,
                        body: { user: duplicateUser[0] }
                    })));
                }
                else {
                    var body = JSON.stringify({ error: 'username does not exit' });
                    var opts = { type: http_1.ResponseType.Error, status: 404, body: body };
                    var responseOpts = new http_1.ResponseOptions(opts);
                    connection.mockError(new MockError(responseOpts));
                }
                return;
            }
            if (connection.request.url.match(/\/api\/Users\/\d+$/) &&
                connection.request.method === http_1.RequestMethod.Get) {
                if (connection.request.headers.get('Authorization') === 'Bearer fake-jwt-token') {
                    var urlParts = connection.request.url.split('/');
                    var id_1 = parseInt(urlParts[urlParts.length - 1]);
                    var matchedUsers = users.filter(function (user) { return user.id === id_1; });
                    var user = matchedUsers.length ? matchedUsers[0] : null;
                    connection.mockRespond(new http_1.Response(new http_1.ResponseOptions({ status: 200, body: user })));
                }
                else {
                    connection.mockRespond(new http_1.Response(new http_1.ResponseOptions({ status: 401 })));
                }
                return;
            }
            if (connection.request.url.endsWith('/api/Users') && connection.request.method === http_1.RequestMethod.Post) {
                var newUser_1 = JSON.parse(connection.request.getBody());
                var duplicateUser = users.filter(function (user) { return user.username === newUser_1.username; }).length;
                if (duplicateUser) {
                    return connection.mockError(new Error('Username "' + newUser_1.username + '" is already taken'));
                }
                newUser_1.id = users.length + Math.floor(Math.random() * (100 - 1)) + 1;
                users.push(newUser_1);
                localStorage.setItem('users', JSON.stringify(users));
                var userRtrn = { status: 200,
                    account: {
                        user: newUser_1,
                        token: 'jwt-token-creation'
                    }
                };
                connection.mockRespond(new http_1.Response(new http_1.ResponseOptions({ status: 200, body: userRtrn })));
                return;
            }
            if (connection.request.url.match(/\/api\/Users\/\d+$/) &&
                connection.request.method === http_1.RequestMethod.Delete) {
                if (connection.request.headers.get('Authorization') === 'Bearer fake-jwt-token') {
                    var urlParts = connection.request.url.split('/');
                    var id = parseInt(urlParts[urlParts.length - 1]);
                    for (var i = 0; i < users.length; i++) {
                        var user = users[i];
                        if (user.id === id) {
                            users.splice(i, 1);
                            localStorage.setItem('users', JSON.stringify(users));
                            break;
                        }
                    }
                    connection.mockRespond(new http_1.Response(new http_1.ResponseOptions({ status: 200 })));
                }
                else {
                    connection.mockRespond(new http_1.Response(new http_1.ResponseOptions({ status: 401 })));
                }
                return;
            }
            var realHttp = new http_1.Http(realBackend, options);
            var requestOptions = new http_1.RequestOptions({
                method: connection.request.method,
                headers: connection.request.headers,
                body: connection.request.getBody(),
                url: connection.request.url,
                withCredentials: connection.request.withCredentials,
                responseType: connection.request.responseType
            });
            realHttp.request(connection.request.url, requestOptions)
                .subscribe(function (response) {
                connection.mockRespond(response);
            }, function (error) {
                connection.mockError(error);
            });
        }, 500);
    });
    return new http_1.Http(backend, options);
}
exports.fakeBackendFactory = fakeBackendFactory;
exports.fakeBackendProvider = {
    provide: http_1.Http,
    useFactory: fakeBackendFactory,
    deps: [testing_1.MockBackend, http_1.BaseRequestOptions, http_1.XHRBackend]
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC9zaGFyZWQtdXRpbHMvZGV2LW1vY2tlZC1iYWNrZW5kL2Zha2UtYmFja2VuZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFBQSxzQ0FDd0Y7QUFFeEYsaURBQW9FO0FBRXBFO0lBQXdCLDZCQUFRO0lBQWhDOztJQUdBLENBQUM7SUFBRCxnQkFBQztBQUFELENBSEEsQUFHQyxDQUh1QixlQUFRLEdBRy9CO0FBR0QsNEJBQW1DLE9BQW9CLEVBQUUsT0FBMkIsRUFBRSxXQUF1QjtJQUV6RyxJQUFJLEtBQUssR0FBVSxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7SUFHbkUsT0FBTyxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsVUFBQyxVQUEwQjtRQUVyRCxVQUFVLENBQUM7WUFHUCxFQUFFLENBQUMsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsMEJBQTBCLENBQUM7Z0JBQzNELFVBQVUsQ0FBQyxPQUFPLENBQUMsTUFBTSxLQUFLLG9CQUFhLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztnQkFFbkQsSUFBSSxRQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7Z0JBRXRELEVBQUUsQ0FBQSxDQUFDLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxRQUFNLENBQUMsUUFBUSxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUM7b0JBQ2xFLFlBQVksQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUM7d0JBQ2hCLEVBQUUsRUFBRSxPQUFPO3dCQUNYLFFBQVEsRUFBRSxTQUFTO3dCQUNuQixRQUFRLEVBQUUsVUFBVTt3QkFDcEIsU0FBUyxFQUFFLE1BQU07d0JBQ2pCLFFBQVEsRUFBRSxTQUFTO3dCQUNuQixLQUFLLEVBQUMsV0FBVzt3QkFDakIsS0FBSyxFQUFFLHNCQUFzQjtxQkFFOUIsQ0FBQyxDQUFDLENBQUM7b0JBRTdCLEtBQUssR0FBVyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2hFLENBQUM7Z0JBR0YsSUFBSSxhQUFhLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxVQUFBLElBQUk7b0JBQ2pDLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxLQUFLLFFBQU0sQ0FBQyxRQUFRLElBQUksSUFBSSxDQUFDLFFBQVEsS0FBSyxRQUFNLENBQUMsUUFBUSxDQUFDO2dCQUNsRixDQUFDLENBQUMsQ0FBQztnQkFFSCxFQUFFLENBQUMsQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztvQkFFdkIsSUFBSSxLQUFLLEdBQUcsYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUM3QixVQUFVLENBQUMsV0FBVyxDQUFDLElBQUksZUFBUSxDQUFDLElBQUksc0JBQWUsQ0FBQzt3QkFDcEQsTUFBTSxFQUFFLEdBQUc7d0JBQ1gsSUFBSSxFQUFDLEVBQUcsT0FBTyxFQUFDO2dDQUNBLElBQUksRUFBRSxLQUFLO2dDQUNYLEtBQUssRUFBQyxLQUFLLENBQUMsS0FBSzs2QkFDaEI7eUJBQ1I7cUJBQ1osQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDVCxDQUFDO2dCQUFDLElBQUksQ0FBQyxDQUFDO29CQUNKLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBQyxLQUFLLEVBQUMsbUNBQW1DLEVBQUMsQ0FBQyxDQUFDO29CQUN2RSxJQUFJLElBQUksR0FBRyxFQUFDLElBQUksRUFBQyxtQkFBWSxDQUFDLEtBQUssRUFBRSxNQUFNLEVBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUMsQ0FBQztvQkFDN0QsSUFBSSxZQUFZLEdBQUcsSUFBSSxzQkFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO29CQUM3QyxVQUFVLENBQUMsU0FBUyxDQUFDLElBQUksU0FBUyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7Z0JBQ3RELENBQUM7Z0JBRUQsTUFBTSxDQUFDO1lBQ1gsQ0FBQztZQUNELEVBQUUsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQywyQkFBMkIsQ0FBQztnQkFDNUQsVUFBVSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEtBQUssb0JBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUVsRCxJQUFJLE9BQU8sR0FBRyxFQUFFLE1BQU0sRUFBRSxHQUFHO29CQUNULE9BQU8sRUFBQzt3QkFDRSxPQUFPLEVBQUMsaUJBQWlCO3dCQUN6QixPQUFPLEVBQUMsSUFBSTtxQkFDYjtpQkFDVixDQUFDO2dCQUNwQixVQUFVLENBQUMsV0FBVyxDQUFDLElBQUksZUFBUSxDQUFDLElBQUksc0JBQWUsQ0FBQyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFDLE9BQU8sRUFBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUN2RixNQUFNLENBQUM7WUFDWCxDQUFDO1lBR0QsRUFBRSxDQUFDLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLDhCQUE4QixDQUFDO2dCQUM1RCxVQUFVLENBQUMsT0FBTyxDQUFDLE1BQU0sS0FBSyxvQkFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBQ2xELElBQUksUUFBUSxHQUFHLFVBQVUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDakQsSUFBSSxVQUFRLEdBQUcsUUFBUSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBSTVDLEVBQUUsQ0FBQSxDQUFDLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxVQUFRLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQztvQkFDNUQsWUFBWSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQzt3QkFDaEIsRUFBRSxFQUFFLE9BQU87d0JBQ1gsUUFBUSxFQUFFLFNBQVM7d0JBQ25CLFFBQVEsRUFBRSxVQUFVO3dCQUNwQixTQUFTLEVBQUUsTUFBTTt3QkFDakIsUUFBUSxFQUFFLFNBQVM7d0JBQ25CLEtBQUssRUFBQyxXQUFXO3dCQUNqQixLQUFLLEVBQUUsc0JBQXNCO3FCQUU5QixDQUFDLENBQUMsQ0FBQztvQkFFN0IsS0FBSyxHQUFXLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDaEUsQ0FBQztnQkFDRixJQUFJLGFBQWEsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLFVBQUEsSUFBSSxJQUFNLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxLQUFLLFVBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNqRixFQUFFLENBQUMsQ0FBQyxhQUFhLElBQUksYUFBYSxDQUFDLE1BQU0sR0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUMxQyxVQUFVLENBQUMsV0FBVyxDQUFDLElBQUksZUFBUSxDQUNLLElBQUksc0JBQWUsQ0FDRTt3QkFDRyxNQUFNLEVBQUUsR0FBRzt3QkFDWCxJQUFJLEVBQUUsRUFBRSxJQUFJLEVBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxFQUFDO3FCQUMvQixDQUNQLENBQ25CLENBQ2QsQ0FBQztnQkFDNUIsQ0FBQztnQkFBQSxJQUFJLENBQUMsQ0FBQztvQkFDSCxJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUMsS0FBSyxFQUFDLHdCQUF3QixFQUFDLENBQUMsQ0FBQztvQkFDNUQsSUFBSSxJQUFJLEdBQUcsRUFBQyxJQUFJLEVBQUMsbUJBQVksQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFDLENBQUM7b0JBQzdELElBQUksWUFBWSxHQUFHLElBQUksc0JBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDN0MsVUFBVSxDQUFDLFNBQVMsQ0FBQyxJQUFJLFNBQVMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO2dCQUN0RCxDQUFDO2dCQUVELE1BQU0sQ0FBQztZQUNYLENBQUM7WUFHRCxFQUFFLENBQUMsQ0FBRSxVQUFVLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsb0JBQW9CLENBQUM7Z0JBQ2xELFVBQVUsQ0FBQyxPQUFPLENBQUMsTUFBTSxLQUFLLG9CQUFhLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFHbkQsRUFBRSxDQUFDLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsQ0FBQyxLQUFLLHVCQUF1QixDQUFDLENBQUMsQ0FBQztvQkFFOUUsSUFBSSxRQUFRLEdBQUcsVUFBVSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO29CQUNqRCxJQUFJLElBQUUsR0FBRyxRQUFRLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDakQsSUFBSSxZQUFZLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxVQUFBLElBQUksSUFBTSxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxJQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDcEUsSUFBSSxJQUFJLEdBQUcsWUFBWSxDQUFDLE1BQU0sR0FBRyxZQUFZLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDO29CQUd4RCxVQUFVLENBQUMsV0FBVyxDQUFDLElBQUksZUFBUSxDQUFDLElBQUksc0JBQWUsQ0FBQyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUMzRixDQUFDO2dCQUFDLElBQUksQ0FBQyxDQUFDO29CQUVKLFVBQVUsQ0FBQyxXQUFXLENBQUMsSUFBSSxlQUFRLENBQUMsSUFBSSxzQkFBZSxDQUFDLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUMvRSxDQUFDO2dCQUVELE1BQU0sQ0FBQztZQUNYLENBQUM7WUFHRCxFQUFFLENBQUMsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLElBQUksVUFBVSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEtBQUssb0JBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUVwRyxJQUFJLFNBQU8sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztnQkFFdkQsSUFBSSxhQUFhLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxVQUFBLElBQUksSUFBTSxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsS0FBSyxTQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO2dCQUNoRyxFQUFFLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO29CQUNoQixNQUFNLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEtBQUssQ0FBQyxZQUFZLEdBQUcsU0FBTyxDQUFDLFFBQVEsR0FBRyxvQkFBb0IsQ0FBQyxDQUFDLENBQUM7Z0JBQ25HLENBQUM7Z0JBR0QsU0FBTyxDQUFDLEVBQUUsR0FBRyxLQUFLLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUUsQ0FBQyxDQUFDO2dCQUNyRSxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQU8sQ0FBQyxDQUFDO2dCQUNwQixZQUFZLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7Z0JBQ3BELElBQUksUUFBUSxHQUFHLEVBQUUsTUFBTSxFQUFFLEdBQUc7b0JBQ1YsT0FBTyxFQUFDO3dCQUNFLElBQUksRUFBQyxTQUFPO3dCQUNaLEtBQUssRUFBRSxvQkFBb0I7cUJBQzVCO2lCQUNWLENBQUM7Z0JBRW5CLFVBQVUsQ0FBQyxXQUFXLENBQUMsSUFBSSxlQUFRLENBQzNCLElBQUksc0JBQWUsQ0FBQyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUksSUFBSSxFQUFDLFFBQVEsRUFBRSxDQUFHLENBQ3RELENBQUMsQ0FBQztnQkFFWCxNQUFNLENBQUM7WUFDWCxDQUFDO1lBR0QsRUFBRSxDQUFDLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLG9CQUFvQixDQUFDO2dCQUNsRCxVQUFVLENBQUMsT0FBTyxDQUFDLE1BQU0sS0FBSyxvQkFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7Z0JBR3JELEVBQUUsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsS0FBSyx1QkFBdUIsQ0FBQyxDQUFDLENBQUM7b0JBRTlFLElBQUksUUFBUSxHQUFHLFVBQVUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztvQkFDakQsSUFBSSxFQUFFLEdBQUcsUUFBUSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ2pELEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO3dCQUNwQyxJQUFJLElBQUksR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBQ3BCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQzs0QkFFakIsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7NEJBQ25CLFlBQVksQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQzs0QkFDckQsS0FBSyxDQUFDO3dCQUNWLENBQUM7b0JBQ0wsQ0FBQztvQkFHRCxVQUFVLENBQUMsV0FBVyxDQUFDLElBQUksZUFBUSxDQUFDLElBQUksc0JBQWUsQ0FBQyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDL0UsQ0FBQztnQkFBQyxJQUFJLENBQUMsQ0FBQztvQkFFSixVQUFVLENBQUMsV0FBVyxDQUFDLElBQUksZUFBUSxDQUFDLElBQUksc0JBQWUsQ0FBQyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDL0UsQ0FBQztnQkFFRCxNQUFNLENBQUM7WUFDWCxDQUFDO1lBR0QsSUFBSSxRQUFRLEdBQUcsSUFBSSxXQUFJLENBQUMsV0FBVyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQzlDLElBQUksY0FBYyxHQUFHLElBQUkscUJBQWMsQ0FBQztnQkFDcEMsTUFBTSxFQUFFLFVBQVUsQ0FBQyxPQUFPLENBQUMsTUFBTTtnQkFDakMsT0FBTyxFQUFFLFVBQVUsQ0FBQyxPQUFPLENBQUMsT0FBTztnQkFDbkMsSUFBSSxFQUFFLFVBQVUsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFO2dCQUNsQyxHQUFHLEVBQUUsVUFBVSxDQUFDLE9BQU8sQ0FBQyxHQUFHO2dCQUMzQixlQUFlLEVBQUUsVUFBVSxDQUFDLE9BQU8sQ0FBQyxlQUFlO2dCQUNuRCxZQUFZLEVBQUUsVUFBVSxDQUFDLE9BQU8sQ0FBQyxZQUFZO2FBQ2hELENBQUMsQ0FBQztZQUNILFFBQVEsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsY0FBYyxDQUFDO2lCQUNuRCxTQUFTLENBQUMsVUFBQyxRQUFrQjtnQkFDMUIsVUFBVSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUNyQyxDQUFDLEVBQ0QsVUFBQyxLQUFVO2dCQUNQLFVBQVUsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDaEMsQ0FBQyxDQUFDLENBQUM7UUFFWCxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFFWixDQUFDLENBQUMsQ0FBQztJQUVILE1BQU0sQ0FBQyxJQUFJLFdBQUksQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFDdEMsQ0FBQztBQXJORCxnREFxTkM7QUFFVSxRQUFBLG1CQUFtQixHQUFHO0lBRTdCLE9BQU8sRUFBRSxXQUFJO0lBQ2IsVUFBVSxFQUFFLGtCQUFrQjtJQUM5QixJQUFJLEVBQUUsQ0FBQyxxQkFBVyxFQUFFLHlCQUFrQixFQUFFLGlCQUFVLENBQUM7Q0FDdEQsQ0FBQyIsImZpbGUiOiJhcHAvc2hhcmVkLXV0aWxzL2Rldi1tb2NrZWQtYmFja2VuZC9mYWtlLWJhY2tlbmQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIdHRwLCBCYXNlUmVxdWVzdE9wdGlvbnMsIFJlc3BvbnNlLCBSZXNwb25zZU9wdGlvbnMsXG4gICAgICAgICBSZXNwb25zZVR5cGUsIFJlcXVlc3RNZXRob2QsIFhIUkJhY2tlbmQsIFJlcXVlc3RPcHRpb25zIH0gZnJvbSAnQGFuZ3VsYXIvaHR0cCc7XG5cbmltcG9ydCB7IE1vY2tCYWNrZW5kLCBNb2NrQ29ubmVjdGlvbiB9IGZyb20gJ0Bhbmd1bGFyL2h0dHAvdGVzdGluZyc7XG5cbmNsYXNzIE1vY2tFcnJvciBleHRlbmRzIFJlc3BvbnNlIGltcGxlbWVudHMgRXJyb3Ige1xuICAgIG5hbWU6YW55O1xuICAgIG1lc3NhZ2U6YW55O1xufVxuXG5cbmV4cG9ydCBmdW5jdGlvbiBmYWtlQmFja2VuZEZhY3RvcnkoYmFja2VuZDogTW9ja0JhY2tlbmQsIG9wdGlvbnM6IEJhc2VSZXF1ZXN0T3B0aW9ucywgcmVhbEJhY2tlbmQ6IFhIUkJhY2tlbmQpIHtcbiAgICAvLyBhcnJheSBpbiBsb2NhbCBzdG9yYWdlIGZvciByZWdpc3RlcmVkIHVzZXJzXG4gICAgbGV0IHVzZXJzOiBhbnlbXSA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oJ3VzZXJzJykpIHx8IFtdO1xuXG4gICAgLy8gY29uZmlndXJlIGZha2UgYmFja2VuZFxuICAgIGJhY2tlbmQuY29ubmVjdGlvbnMuc3Vic2NyaWJlKChjb25uZWN0aW9uOiBNb2NrQ29ubmVjdGlvbikgPT4ge1xuICAgICAgICAvLyB3cmFwIGluIHRpbWVvdXQgdG8gc2ltdWxhdGUgc2VydmVyIGFwaSBjYWxsXG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuXG4gICAgICAgICAgICAvLyBhdXRoZW50aWNhdGVcbiAgICAgICAgICAgIGlmIChjb25uZWN0aW9uLnJlcXVlc3QudXJsLmVuZHNXaXRoKCdhcGkvQXV0aG9yaXphdGlvbnMvTG9naW4nKSAmJlxuICAgICAgICAgICAgICAgIGNvbm5lY3Rpb24ucmVxdWVzdC5tZXRob2QgPT09IFJlcXVlc3RNZXRob2QuUG9zdCkge1xuICAgICAgICAgICAgICAgIC8vIGdldCBwYXJhbWV0ZXJzIGZyb20gcG9zdCByZXF1ZXN0XG4gICAgICAgICAgICAgICAgbGV0IHBhcmFtcyA9IEpTT04ucGFyc2UoY29ubmVjdGlvbi5yZXF1ZXN0LmdldEJvZHkoKSk7XG5cbiAgICAgICAgICAgICAgICBpZighbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ3VzZXJzJykgJiYgcGFyYW1zLnVzZXJuYW1lID09PSAndGFvYmluZycpIHtcbiAgICAgICAgICAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgndXNlcnMnLCBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogJzEyMzQ1JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJuYW1lOiAndGFvYmluZycsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXNzd29yZDogJ3Bhc3N3b3JkJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0bmFtZTogJ1Rob3InLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdG5hbWU6ICdOZXdzc2VuJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVtYWlsOid0bkBnbS5jb20nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW46ICcxMjM0NS1mYWtlLWp3dC10b2tlbidcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pKTtcblxuICAgICAgICAgICAgICAgICAgICAgdXNlcnMgID0gPGFueVtdPltKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKCd1c2VycycpKV07XG4gICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIC8vIGZpbmQgaWYgYW55IHVzZXIgbWF0Y2hlcyBsb2dpbiBjcmVkZW50aWFsc1xuICAgICAgICAgICAgICAgIGxldCBmaWx0ZXJlZFVzZXJzID0gdXNlcnMuZmlsdGVyKHVzZXIgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdXNlci51c2VybmFtZSA9PT0gcGFyYW1zLnVzZXJuYW1lICYmIHVzZXIucGFzc3dvcmQgPT09IHBhcmFtcy5wYXNzd29yZDtcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIGlmIChmaWx0ZXJlZFVzZXJzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICAvLyBpZiBsb2dpbiBkZXRhaWxzIGFyZSB2YWxpZCByZXR1cm4gMjAwIE9LIHdpdGggdXNlciBkZXRhaWxzIGFuZCBmYWtlIGp3dCB0b2tlblxuICAgICAgICAgICAgICAgICAgICBsZXQgYVVzZXIgPSBmaWx0ZXJlZFVzZXJzWzBdO1xuICAgICAgICAgICAgICAgICAgICBjb25uZWN0aW9uLm1vY2tSZXNwb25kKG5ldyBSZXNwb25zZShuZXcgUmVzcG9uc2VPcHRpb25zKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1czogMjAwLFxuICAgICAgICAgICAgICAgICAgICAgICAgYm9keTp7ICBhY2NvdW50OntcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VyOiBhVXNlcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbjphVXNlci50b2tlblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KSkpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBib2R5ID0gSlNPTi5zdHJpbmdpZnkoe2Vycm9yOidVc2VybmFtZSBvciBwYXNzd29yZCBpcyBpbmNvcnJlY3QnfSk7XG4gICAgICAgICAgICAgICAgICAgIGxldCBvcHRzID0ge3R5cGU6UmVzcG9uc2VUeXBlLkVycm9yLCBzdGF0dXM6NDAwLCBib2R5OiBib2R5fTtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHJlc3BvbnNlT3B0cyA9IG5ldyBSZXNwb25zZU9wdGlvbnMob3B0cyk7XG4gICAgICAgICAgICAgICAgICAgIGNvbm5lY3Rpb24ubW9ja0Vycm9yKG5ldyBNb2NrRXJyb3IocmVzcG9uc2VPcHRzKSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGNvbm5lY3Rpb24ucmVxdWVzdC51cmwuZW5kc1dpdGgoJ2FwaS9BdXRob3JpemF0aW9ucy9Mb2dvdXQnKSAmJlxuICAgICAgICAgICAgICAgIGNvbm5lY3Rpb24ucmVxdWVzdC5tZXRob2QgPT09IFJlcXVlc3RNZXRob2QuUG9zdCkge1xuICAgICAgICAgICAgICAgIC8vIGdldCBwYXJhbWV0ZXJzIGZyb20gcG9zdCByZXF1ZXN0XG4gICAgICAgICAgICAgICAgIGxldCB1c2VyT3V0ID0geyBzdGF0dXM6IDIwMCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2VuZXJhbDp7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOid1c2VyIGxvZ2dlZCBvdXQnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3VjY2Vzczp0cnVlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgIGNvbm5lY3Rpb24ubW9ja1Jlc3BvbmQobmV3IFJlc3BvbnNlKG5ldyBSZXNwb25zZU9wdGlvbnMoeyBzdGF0dXM6IDIwMCwgYm9keTp1c2VyT3V0fSkpKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIGdldCB1c2VyIGJ5IHVzZXJzbmFtZVxuICAgICAgICAgICAgaWYgKGNvbm5lY3Rpb24ucmVxdWVzdC51cmwubWF0Y2goL1xcL2FwaVxcL1VzZXJzXFwvdXNlcm5hbWVcXC9cXHcrJC8pICAmJlxuICAgICAgICAgICAgICAgIGNvbm5lY3Rpb24ucmVxdWVzdC5tZXRob2QgPT09IFJlcXVlc3RNZXRob2QuR2V0KSB7XG4gICAgICAgICAgICAgICAgbGV0IHVybFBhcnRzID0gY29ubmVjdGlvbi5yZXF1ZXN0LnVybC5zcGxpdCgnLycpO1xuICAgICAgICAgICAgICAgIGxldCB1c2VybmFtZSA9IHVybFBhcnRzW3VybFBhcnRzLmxlbmd0aCAtIDFdO1xuICAgICAgICAgICAgICAgIC8vIGNoZWNrIGZvciBmYWtlIGF1dGggdG9rZW4gaW4gaGVhZGVyIGFuZCByZXR1cm4gdXNlcnMgaWZcbiAgICAgICAgICAgICAgICAvLyB2YWxpZCwgdGhpcyBzZWN1cml0eSBpcyBpbXBsZW1lbnRlZCBzZXJ2ZXIgc2lkZSBpbiBhIHJlYWwgYXBwbGljYXRpb25cblxuICAgICAgICAgICAgICAgICBpZighbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ3VzZXJzJykgJiYgdXNlcm5hbWUgPT09ICd0YW9iaW5nJykge1xuICAgICAgICAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCd1c2VycycsIEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiAnMTIzNDUnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlcm5hbWU6ICd0YW9iaW5nJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhc3N3b3JkOiAncGFzc3dvcmQnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlyc3RuYW1lOiAnVGhvcicsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0bmFtZTogJ05ld3NzZW4nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW1haWw6J3RuQGdtLmNvbScsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbjogJzEyMzQ1LWZha2Utand0LXRva2VuJ1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkpO1xuXG4gICAgICAgICAgICAgICAgICAgICB1c2VycyAgPSA8YW55W10+W0pTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oJ3VzZXJzJykpXTtcbiAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGxldCBkdXBsaWNhdGVVc2VyID0gdXNlcnMuZmlsdGVyKHVzZXIgPT4geyByZXR1cm4gdXNlci51c2VybmFtZSA9PT0gdXNlcm5hbWU7IH0pO1xuICAgICAgICAgICAgICAgIGlmIChkdXBsaWNhdGVVc2VyICYmIGR1cGxpY2F0ZVVzZXIubGVuZ3RoPjApIHtcbiAgICAgICAgICAgICAgICAgICAgY29ubmVjdGlvbi5tb2NrUmVzcG9uZChuZXcgUmVzcG9uc2UoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXcgUmVzcG9uc2VPcHRpb25zKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzOiAyMDAsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib2R5OiB7IHVzZXI6ZHVwbGljYXRlVXNlclswXX1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfWVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBsZXQgYm9keSA9IEpTT04uc3RyaW5naWZ5KHtlcnJvcjondXNlcm5hbWUgZG9lcyBub3QgZXhpdCd9KTtcbiAgICAgICAgICAgICAgICAgICAgbGV0IG9wdHMgPSB7dHlwZTpSZXNwb25zZVR5cGUuRXJyb3IsIHN0YXR1czo0MDQsIGJvZHk6IGJvZHl9O1xuICAgICAgICAgICAgICAgICAgICBsZXQgcmVzcG9uc2VPcHRzID0gbmV3IFJlc3BvbnNlT3B0aW9ucyhvcHRzKTtcbiAgICAgICAgICAgICAgICAgICAgY29ubmVjdGlvbi5tb2NrRXJyb3IobmV3IE1vY2tFcnJvcihyZXNwb25zZU9wdHMpKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIGdldCB1c2VyIGJ5IGlkXG4gICAgICAgICAgICBpZiAoIGNvbm5lY3Rpb24ucmVxdWVzdC51cmwubWF0Y2goL1xcL2FwaVxcL1VzZXJzXFwvXFxkKyQvKSAmJlxuICAgICAgICAgICAgICAgICBjb25uZWN0aW9uLnJlcXVlc3QubWV0aG9kID09PSBSZXF1ZXN0TWV0aG9kLkdldCkge1xuICAgICAgICAgICAgICAgIC8vIGNoZWNrIGZvciBmYWtlIGF1dGggdG9rZW4gaW4gaGVhZGVyIGFuZCByZXR1cm4gdXNlclxuICAgICAgICAgICAgICAgIC8vIGlmIHZhbGlkLCB0aGlzIHNlY3VyaXR5IGlzIGltcGxlbWVudGVkIHNlcnZlciBzaWRlIGluIGEgcmVhbCBhcHBsaWNhdGlvblxuICAgICAgICAgICAgICAgIGlmIChjb25uZWN0aW9uLnJlcXVlc3QuaGVhZGVycy5nZXQoJ0F1dGhvcml6YXRpb24nKSA9PT0gJ0JlYXJlciBmYWtlLWp3dC10b2tlbicpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gZmluZCB1c2VyIGJ5IGlkIGluIHVzZXJzIGFycmF5XG4gICAgICAgICAgICAgICAgICAgIGxldCB1cmxQYXJ0cyA9IGNvbm5lY3Rpb24ucmVxdWVzdC51cmwuc3BsaXQoJy8nKTtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGlkID0gcGFyc2VJbnQodXJsUGFydHNbdXJsUGFydHMubGVuZ3RoIC0gMV0pO1xuICAgICAgICAgICAgICAgICAgICBsZXQgbWF0Y2hlZFVzZXJzID0gdXNlcnMuZmlsdGVyKHVzZXIgPT4geyByZXR1cm4gdXNlci5pZCA9PT0gaWQ7IH0pO1xuICAgICAgICAgICAgICAgICAgICBsZXQgdXNlciA9IG1hdGNoZWRVc2Vycy5sZW5ndGggPyBtYXRjaGVkVXNlcnNbMF0gOiBudWxsO1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIHJlc3BvbmQgMjAwIE9LIHdpdGggdXNlclxuICAgICAgICAgICAgICAgICAgICBjb25uZWN0aW9uLm1vY2tSZXNwb25kKG5ldyBSZXNwb25zZShuZXcgUmVzcG9uc2VPcHRpb25zKHsgc3RhdHVzOiAyMDAsIGJvZHk6IHVzZXIgfSkpKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAvLyByZXR1cm4gNDAxIG5vdCBhdXRob3Jpc2VkIGlmIHRva2VuIGlzIG51bGwgb3IgaW52YWxpZFxuICAgICAgICAgICAgICAgICAgICBjb25uZWN0aW9uLm1vY2tSZXNwb25kKG5ldyBSZXNwb25zZShuZXcgUmVzcG9uc2VPcHRpb25zKHsgc3RhdHVzOiA0MDEgfSkpKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIGNyZWF0ZSB1c2VyXG4gICAgICAgICAgICBpZiAoY29ubmVjdGlvbi5yZXF1ZXN0LnVybC5lbmRzV2l0aCgnL2FwaS9Vc2VycycpICYmIGNvbm5lY3Rpb24ucmVxdWVzdC5tZXRob2QgPT09IFJlcXVlc3RNZXRob2QuUG9zdCkge1xuICAgICAgICAgICAgICAgIC8vIGdldCBuZXcgdXNlciBvYmplY3QgZnJvbSBwb3N0IGJvZHlcbiAgICAgICAgICAgICAgICBsZXQgbmV3VXNlciA9IEpTT04ucGFyc2UoY29ubmVjdGlvbi5yZXF1ZXN0LmdldEJvZHkoKSk7XG4gICAgICAgICAgICAgICAgLy8gdmFsaWRhdGlvblxuICAgICAgICAgICAgICAgIGxldCBkdXBsaWNhdGVVc2VyID0gdXNlcnMuZmlsdGVyKHVzZXIgPT4geyByZXR1cm4gdXNlci51c2VybmFtZSA9PT0gbmV3VXNlci51c2VybmFtZTsgfSkubGVuZ3RoO1xuICAgICAgICAgICAgICAgIGlmIChkdXBsaWNhdGVVc2VyKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBjb25uZWN0aW9uLm1vY2tFcnJvcihuZXcgRXJyb3IoJ1VzZXJuYW1lIFwiJyArIG5ld1VzZXIudXNlcm5hbWUgKyAnXCIgaXMgYWxyZWFkeSB0YWtlbicpKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAvLyBzYXZlIG5ldyB1c2VyXG4gICAgICAgICAgICAgICAgbmV3VXNlci5pZCA9IHVzZXJzLmxlbmd0aCArIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqICgxMDAgLSAxKSkgKzE7XG4gICAgICAgICAgICAgICAgdXNlcnMucHVzaChuZXdVc2VyKTtcbiAgICAgICAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgndXNlcnMnLCBKU09OLnN0cmluZ2lmeSh1c2VycykpO1xuICAgICAgICAgICAgICAgICBsZXQgdXNlclJ0cm4gPSB7IHN0YXR1czogMjAwLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50OntcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZXI6bmV3VXNlcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRva2VuOiAnand0LXRva2VuLWNyZWF0aW9uJ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgLy8gcmVzcG9uZCAyMDAgT0tcbiAgICAgICAgICAgICAgICBjb25uZWN0aW9uLm1vY2tSZXNwb25kKG5ldyBSZXNwb25zZShcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ldyBSZXNwb25zZU9wdGlvbnMoeyBzdGF0dXM6IDIwMCwgICBib2R5OnVzZXJSdHJuIH0gIClcbiAgICAgICAgICAgICAgICAgICAgICAgICkpO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBkZWxldGUgdXNlclxuICAgICAgICAgICAgaWYgKGNvbm5lY3Rpb24ucmVxdWVzdC51cmwubWF0Y2goL1xcL2FwaVxcL1VzZXJzXFwvXFxkKyQvKSAmJlxuICAgICAgICAgICAgICAgIGNvbm5lY3Rpb24ucmVxdWVzdC5tZXRob2QgPT09IFJlcXVlc3RNZXRob2QuRGVsZXRlKSB7XG4gICAgICAgICAgICAgICAgLy8gY2hlY2sgZm9yIGZha2UgYXV0aCB0b2tlbiBpbiBoZWFkZXIgYW5kIHJldHVybiB1c2VyIGlmIHZhbGlkLCB0aGlzXG4gICAgICAgICAgICAgICAgLy8gc2VjdXJpdHkgaXMgaW1wbGVtZW50ZWQgc2VydmVyIHNpZGUgaW4gYSByZWFsIGFwcGxpY2F0aW9uXG4gICAgICAgICAgICAgICAgaWYgKGNvbm5lY3Rpb24ucmVxdWVzdC5oZWFkZXJzLmdldCgnQXV0aG9yaXphdGlvbicpID09PSAnQmVhcmVyIGZha2Utand0LXRva2VuJykge1xuICAgICAgICAgICAgICAgICAgICAvLyBmaW5kIHVzZXIgYnkgaWQgaW4gdXNlcnMgYXJyYXlcbiAgICAgICAgICAgICAgICAgICAgbGV0IHVybFBhcnRzID0gY29ubmVjdGlvbi5yZXF1ZXN0LnVybC5zcGxpdCgnLycpO1xuICAgICAgICAgICAgICAgICAgICBsZXQgaWQgPSBwYXJzZUludCh1cmxQYXJ0c1t1cmxQYXJ0cy5sZW5ndGggLSAxXSk7XG4gICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdXNlcnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCB1c2VyID0gdXNlcnNbaV07XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodXNlci5pZCA9PT0gaWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBkZWxldGUgdXNlclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJzLnNwbGljZShpLCAxKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgndXNlcnMnLCBKU09OLnN0cmluZ2lmeSh1c2VycykpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gcmVzcG9uZCAyMDAgT0tcbiAgICAgICAgICAgICAgICAgICAgY29ubmVjdGlvbi5tb2NrUmVzcG9uZChuZXcgUmVzcG9uc2UobmV3IFJlc3BvbnNlT3B0aW9ucyh7IHN0YXR1czogMjAwIH0pKSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gcmV0dXJuIDQwMSBub3QgYXV0aG9yaXNlZCBpZiB0b2tlbiBpcyBudWxsIG9yIGludmFsaWRcbiAgICAgICAgICAgICAgICAgICAgY29ubmVjdGlvbi5tb2NrUmVzcG9uZChuZXcgUmVzcG9uc2UobmV3IFJlc3BvbnNlT3B0aW9ucyh7IHN0YXR1czogNDAxIH0pKSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBwYXNzIHRocm91Z2ggYW55IHJlcXVlc3RzIG5vdCBoYW5kbGVkIGFib3ZlXG4gICAgICAgICAgICBsZXQgcmVhbEh0dHAgPSBuZXcgSHR0cChyZWFsQmFja2VuZCwgb3B0aW9ucyk7XG4gICAgICAgICAgICBsZXQgcmVxdWVzdE9wdGlvbnMgPSBuZXcgUmVxdWVzdE9wdGlvbnMoe1xuICAgICAgICAgICAgICAgIG1ldGhvZDogY29ubmVjdGlvbi5yZXF1ZXN0Lm1ldGhvZCxcbiAgICAgICAgICAgICAgICBoZWFkZXJzOiBjb25uZWN0aW9uLnJlcXVlc3QuaGVhZGVycyxcbiAgICAgICAgICAgICAgICBib2R5OiBjb25uZWN0aW9uLnJlcXVlc3QuZ2V0Qm9keSgpLFxuICAgICAgICAgICAgICAgIHVybDogY29ubmVjdGlvbi5yZXF1ZXN0LnVybCxcbiAgICAgICAgICAgICAgICB3aXRoQ3JlZGVudGlhbHM6IGNvbm5lY3Rpb24ucmVxdWVzdC53aXRoQ3JlZGVudGlhbHMsXG4gICAgICAgICAgICAgICAgcmVzcG9uc2VUeXBlOiBjb25uZWN0aW9uLnJlcXVlc3QucmVzcG9uc2VUeXBlXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJlYWxIdHRwLnJlcXVlc3QoY29ubmVjdGlvbi5yZXF1ZXN0LnVybCwgcmVxdWVzdE9wdGlvbnMpXG4gICAgICAgICAgICAgICAgLnN1YnNjcmliZSgocmVzcG9uc2U6IFJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbm5lY3Rpb24ubW9ja1Jlc3BvbmQocmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgKGVycm9yOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29ubmVjdGlvbi5tb2NrRXJyb3IoZXJyb3IpO1xuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH0sIDUwMCk7XG5cbiAgICB9KTtcblxuICAgIHJldHVybiBuZXcgSHR0cChiYWNrZW5kLCBvcHRpb25zKTtcbn1cblxuZXhwb3J0IGxldCBmYWtlQmFja2VuZFByb3ZpZGVyID0ge1xuICAgIC8vIHVzZSBmYWtlIGJhY2tlbmQgaW4gcGxhY2Ugb2YgSHR0cCBzZXJ2aWNlIGZvciBiYWNrZW5kLWxlc3MgZGV2ZWxvcG1lbnRcbiAgICBwcm92aWRlOiBIdHRwLFxuICAgIHVzZUZhY3Rvcnk6IGZha2VCYWNrZW5kRmFjdG9yeSxcbiAgICBkZXBzOiBbTW9ja0JhY2tlbmQsIEJhc2VSZXF1ZXN0T3B0aW9ucywgWEhSQmFja2VuZF1cbn07Il19
